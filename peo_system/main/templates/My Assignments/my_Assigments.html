{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{% static 'CSS/styles.css' %}">
  <title>My Assignments</title>
  <style>
    :root {
      --assign-bg: #f1f3f6;
      --assign-panel: #f9fbfd;
      --assign-border: #cdd3db;
      --assign-text: #0a213e;
      --assign-muted: #5a6b7f;
      --assign-warn: #f0ab00;
      --assign-info: #2a76f8;
      --assign-ok: #09bf55;
      --assign-option-active: #f8b32b;
      --assign-shadow: 0 4px 12px rgba(17, 31, 45, 0.16);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--assign-bg);
      color: var(--assign-text);
      font-family: "Sora", "Segoe UI", sans-serif;
      font-size: clamp(14px, 0.9vw, 15px);
    }

    .assignments-shell {
      width: min(1220px, 100%);
      margin: 0 auto;
      padding: clamp(14px, 2vw, 24px) clamp(12px, 2vw, 20px) clamp(18px, 2.4vw, 28px);
    }

    .assignments-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 14px;
    }

    .assignments-header h1 {
      margin: 0;
      font-size: clamp(1.8rem, 2.7vw, 2.45rem);
      line-height: 1.1;
      letter-spacing: -0.03em;
      color: #041b38;
    }

    .assignments-header p {
      margin: 6px 0 0;
      color: #4f6278;
      font-size: 1rem;
    }

    .total-pill {
      border: 1px solid var(--assign-border);
      border-radius: 10px;
      background: #f8f9fb;
      color: #112744;
      padding: 6px 12px;
      font-size: 0.97rem;
      font-weight: 600;
      white-space: nowrap;
      margin-top: 2px;
    }

    .assignments-stats {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: clamp(10px, 1.3vw, 14px);
      margin-bottom: 14px;
    }

    .stat-card {
      background: var(--assign-panel);
      border: 1px solid var(--assign-border);
      border-radius: 16px;
      min-height: 116px;
      padding: clamp(14px, 1.8vw, 20px) clamp(14px, 1.8vw, 22px);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .stat-title {
      margin: 0;
      color: #5d6f85;
      font-size: 1rem;
      font-weight: 500;
    }

    .stat-value {
      margin: 4px 0 0;
      font-size: clamp(2.1rem, 3.2vw, 2.65rem);
      line-height: 1;
      font-weight: 700;
      color: #031f3f;
    }

    .stat-icon svg {
      width: clamp(28px, 2.1vw, 34px);
      height: clamp(28px, 2.1vw, 34px);
    }

    .warn {
      color: var(--assign-warn);
    }

    .info {
      color: var(--assign-info);
    }

    .ok {
      color: var(--assign-ok);
    }

    .filters-panel {
      background: var(--assign-panel);
      border: 1px solid var(--assign-border);
      border-radius: 16px;
      padding: clamp(14px, 1.8vw, 22px) clamp(12px, 1.6vw, 20px) clamp(12px, 1.6vw, 20px);
      margin-bottom: 14px;
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(220px, 1fr));
      gap: 14px;
      align-items: end;
    }

    .filter-field label {
      display: block;
      margin-bottom: 6px;
      color: #102946;
      font-size: 0.97rem;
      font-weight: 600;
    }

    .filter-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-icon {
      flex: 0 0 auto;
      width: 20px;
      height: 20px;
      color: #5f7184;
      margin-top: 2px;
    }

    .select-wrap {
      position: relative;
      display: block;
      min-width: 0;
      width: 100%;
      max-width: 340px;
    }

    .select-trigger {
      width: 100%;
      min-height: 42px;
      border: 1px solid var(--assign-border);
      border-radius: 12px;
      background: #f8fafc;
      color: #173455;
      font: inherit;
      font-size: 0.99rem;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      cursor: pointer;
    }

    .select-trigger:hover {
      border-color: #bdc7d2;
    }

    .select-trigger:focus-visible {
      outline: 2px solid #8fb6ff;
      outline-offset: 1px;
    }

    .select-chevron {
      width: 16px;
      height: 16px;
      color: #9aa8b8;
      transition: transform 0.2s ease;
    }

    .select-wrap.open .select-chevron {
      transform: rotate(180deg);
    }

    .select-menu {
      position: absolute;
      left: 0;
      top: calc(100% + 6px);
      min-width: 100%;
      padding: 6px;
      border-radius: 12px;
      border: 1px solid #d0d6de;
      background: #f4f5f7;
      box-shadow: var(--assign-shadow);
      display: none;
      z-index: 8;
    }

    .select-wrap.open .select-menu {
      display: block;
    }

    .select-option {
      border: 0;
      width: 100%;
      text-align: left;
      background: transparent;
      color: #263748;
      border-radius: 8px;
      padding: 8px 10px;
      font: inherit;
      font-size: 0.97rem;
      line-height: 1.2;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
    }

    .select-option:hover {
      background: #eceff4;
    }

    .select-option.active {
      background: var(--assign-option-active);
      color: #1f2630;
    }

    .option-check {
      opacity: 0;
      font-size: 1rem;
      font-weight: 700;
    }

    .select-option.active .option-check {
      opacity: 1;
    }

    .assignments-table-panel {
      background: var(--assign-panel);
      border: 1px solid var(--assign-border);
      border-radius: 16px;
      overflow: hidden;
    }

    .assignments-table-wrap {
      overflow-x: auto;
      background: #fff;
    }

    .assignments-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1080px;
    }

    .assignments-table th,
    .assignments-table td {
      padding: 10px 12px;
      border-bottom: 1px solid #dce2ea;
      text-align: left;
      vertical-align: top;
    }

    .assignments-table th {
      background: #f3f6fa;
      color: #17314d;
      font-size: 0.88rem;
      letter-spacing: 0.01em;
      white-space: nowrap;
    }

    .assignments-table td {
      color: #20374f;
      font-size: 0.93rem;
    }

    .assignments-table tbody tr:last-child td {
      border-bottom: 0;
    }

    .assignments-empty-row td {
      text-align: center;
      color: #60758d;
      font-style: italic;
      padding: 18px 12px;
    }

    .status-pill {
      display: inline-block;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.78rem;
      font-weight: 700;
      white-space: nowrap;
    }

    .status-pending {
      background: #fdecc5;
      color: #9a5b00;
    }

    .status-progress {
      background: #d8e9ff;
      color: #1458c5;
    }

    .status-complete {
      background: #d4f1df;
      color: #0a8744;
    }

    .assignment-action {
      display: grid;
      gap: 6px;
      min-width: 220px;
    }

    .assignment-action-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .action-select {
      min-height: 34px;
      border: 1px solid #bcc8d5;
      border-radius: 8px;
      background: #fff;
      color: #24415d;
      font: inherit;
      font-size: 0.88rem;
      padding: 0 8px;
      min-width: 126px;
    }

    .percent-box {
      min-height: 34px;
      border: 1px solid #bcc8d5;
      border-radius: 8px;
      background: #fff;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 0 8px;
    }

    .percent-value {
      min-width: 52px;
      font-size: 0.9rem;
      font-weight: 700;
      color: #284863;
      text-align: right;
    }

    .progress-track {
      height: 7px;
      border-radius: 999px;
      background: #e4ebf2;
      overflow: hidden;
    }

    .progress-fill {
      display: block;
      height: 100%;
      width: 0;
      border-radius: inherit;
      background: linear-gradient(90deg, #2b74f8, #09bf55);
      transition: width 0.2s ease;
    }

    @media (max-width: 1080px) {
      .assignments-stats {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .filters-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 700px) {
      .assignments-header {
        flex-wrap: wrap;
      }

      .total-pill {
        width: 100%;
        text-align: center;
      }

      .assignments-stats {
        grid-template-columns: 1fr;
      }

      .stat-value {
        font-size: 2.15rem;
      }

      .select-wrap {
        max-width: none;
      }
    }

    @media (max-width: 520px) {
      .assignments-shell {
        padding: 14px 10px 18px;
      }

      .stat-card {
        padding: 14px;
      }

      .assignment-action {
        min-width: 190px;
      }
    }
  </style>
</head>
<body>
  <main class="assignments-shell">
    <header class="assignments-header">
      <div>
        <h1>My Assignments</h1>
        <p>Track and manage your assigned POW tasks</p>
      </div>
      <div class="total-pill" id="totalTasksPill">0 Total Tasks</div>
    </header>

    <section class="assignments-stats">
      <article class="stat-card">
        <div>
          <p class="stat-title">Pending</p>
          <p class="stat-value" id="pendingCount">0</p>
        </div>
        <div class="stat-icon warn" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
            <path d="M12 7v5l3 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
      </article>

      <article class="stat-card">
        <div>
          <p class="stat-title">In Progress</p>
          <p class="stat-value" id="inProgressCount">0</p>
        </div>
        <div class="stat-icon info" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
            <path d="M12 8v5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <circle cx="12" cy="16.5" r="1" fill="currentColor"/>
          </svg>
        </div>
      </article>

      <article class="stat-card">
        <div>
          <p class="stat-title">Completed</p>
          <p class="stat-value" id="completedCount">0</p>
        </div>
        <div class="stat-icon ok" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
            <path d="m8.8 12.2 2.2 2.2 4.2-4.2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      </article>
    </section>

    <section class="filters-panel">
      <div class="filters-grid">
        <div class="filter-field">
          <label id="taskTypeLabel" for="taskTypeTrigger">Task Type</label>
          <div class="filter-row">
            <svg class="filter-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M4 5h16l-6 7v6l-4 2v-8L4 5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            </svg>
            <div class="select-wrap" data-select>
              <button id="taskTypeTrigger" class="select-trigger" type="button" aria-haspopup="listbox" aria-expanded="false" aria-labelledby="taskTypeLabel taskTypeValue">
                <span id="taskTypeValue">All Task Types</span>
                <svg class="select-chevron" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
              <div class="select-menu" role="listbox" aria-label="Task Type options">
                <button class="select-option active" type="button" data-value="All Task Types">
                  <span>All Task Types</span>
                  <span class="option-check">&#10003;</span>
                </button>
                <button class="select-option" type="button" data-value="Inspection">
                  <span>Inspection</span>
                  <span class="option-check">&#10003;</span>
                </button>
                <button class="select-option" type="button" data-value="POW Review">
                  <span>POW Review</span>
                  <span class="option-check">&#10003;</span>
                </button>
                <button class="select-option" type="button" data-value="Construction Monitoring">
                  <span>Construction Monitoring</span>
                  <span class="option-check">&#10003;</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="filter-field">
          <label id="taskStatusLabel" for="taskStatusTrigger">Status</label>
          <div class="filter-row">
            <div class="select-wrap" data-select>
              <button id="taskStatusTrigger" class="select-trigger" type="button" aria-haspopup="listbox" aria-expanded="false" aria-labelledby="taskStatusLabel taskStatusValue">
                <span id="taskStatusValue">All Statuses</span>
                <svg class="select-chevron" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
              <div class="select-menu" role="listbox" aria-label="Status options">
                <button class="select-option active" type="button" data-value="All Statuses">
                  <span>All Statuses</span>
                  <span class="option-check">&#10003;</span>
                </button>
                <button class="select-option" type="button" data-value="Pending">
                  <span>Pending</span>
                  <span class="option-check">&#10003;</span>
                </button>
                <button class="select-option" type="button" data-value="In Progress">
                  <span>In Progress</span>
                  <span class="option-check">&#10003;</span>
                </button>
                <button class="select-option" type="button" data-value="Completed">
                  <span>Completed</span>
                  <span class="option-check">&#10003;</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="assignments-table-panel" aria-label="Assignments table">
      <div class="assignments-table-wrap">
        <table class="assignments-table">
          <thead>
            <tr>
              <th>ID Track</th>
              <th>Name Project</th>
              <th>Category</th>
              <th>Task Types</th>
              <th>Date Recieve</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="assignmentTableBody">
            <tr data-assignment-row="1" data-task-type="Inspection" data-default-progress="45">
              <td>TRK-001</td>
              <td>Riverside Bridge Rehabilitation</td>
              <td>Bridge</td>
              <td>Inspection</td>
              <td>2026-02-20</td>
              <td><span class="status-pill status-progress" data-status-pill>In Progress</span></td>
              <td>
                <div class="assignment-action">
                  <div class="assignment-action-row">
                    <select class="action-select" data-action-select>
                      <option value="not-complete" selected>Not Complete</option>
                      <option value="complete">Complete</option>
                    </select>
                    <div class="percent-box" aria-label="Progress percent">
                      <span class="percent-value" data-progress-value>45%</span>
                    </div>
                  </div>
                  <div class="progress-track" aria-hidden="true">
                    <span class="progress-fill" data-progress-fill style="width: 45%;"></span>
                  </div>
                </div>
              </td>
            </tr>
            <tr data-assignment-row="1" data-task-type="POW Review" data-default-progress="0">
              <td>TRK-002</td>
              <td>Provincial Road Section 7 Overlay</td>
              <td>Road</td>
              <td>POW Review</td>
              <td>2026-02-18</td>
              <td><span class="status-pill status-pending" data-status-pill>Pending</span></td>
              <td>
                <div class="assignment-action">
                  <div class="assignment-action-row">
                    <select class="action-select" data-action-select>
                      <option value="not-complete" selected>Not Complete</option>
                      <option value="complete">Complete</option>
                    </select>
                    <div class="percent-box" aria-label="Progress percent">
                      <span class="percent-value" data-progress-value>0%</span>
                    </div>
                  </div>
                  <div class="progress-track" aria-hidden="true">
                    <span class="progress-fill" data-progress-fill style="width: 0%;"></span>
                  </div>
                </div>
              </td>
            </tr>
            <tr data-assignment-row="1" data-task-type="Construction Monitoring" data-default-progress="100">
              <td>TRK-003</td>
              <td>Barangay Access Road Concreting</td>
              <td>Road</td>
              <td>Construction Monitoring</td>
              <td>2026-02-15</td>
              <td><span class="status-pill status-complete" data-status-pill>Completed</span></td>
              <td>
                <div class="assignment-action">
                  <div class="assignment-action-row">
                    <select class="action-select" data-action-select>
                      <option value="not-complete">Not Complete</option>
                      <option value="complete" selected>Complete</option>
                    </select>
                    <div class="percent-box" aria-label="Progress percent">
                      <span class="percent-value" data-progress-value>100%</span>
                    </div>
                  </div>
                  <div class="progress-track" aria-hidden="true">
                    <span class="progress-fill" data-progress-fill style="width: 100%;"></span>
                  </div>
                </div>
              </td>
            </tr>
            <tr id="assignmentEmptyRow" class="assignments-empty-row" hidden>
              <td colspan="7">No assignments match the current filter.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>
  <script>
    (function () {
      var selectWrappers = document.querySelectorAll("[data-select]");
      var assignmentRows = Array.prototype.slice.call(document.querySelectorAll("tr[data-assignment-row='1']"));
      var taskTypeValue = document.getElementById("taskTypeValue");
      var taskStatusValue = document.getElementById("taskStatusValue");
      var assignmentEmptyRow = document.getElementById("assignmentEmptyRow");
      var totalTasksPill = document.getElementById("totalTasksPill");
      var pendingCountEl = document.getElementById("pendingCount");
      var inProgressCountEl = document.getElementById("inProgressCount");
      var completedCountEl = document.getElementById("completedCount");

      function closeAll(except) {
        selectWrappers.forEach(function (wrapper) {
          if (wrapper !== except) {
            wrapper.classList.remove("open");
            var btn = wrapper.querySelector(".select-trigger");
            if (btn) {
              btn.setAttribute("aria-expanded", "false");
            }
          }
        });
      }

      function normalize(value) {
        return String(value || "").trim().toLowerCase();
      }

      function clampPercent(value, min, max) {
        if (isNaN(value)) {
          return min;
        }
        return Math.max(min, Math.min(max, value));
      }

      function statusClassFromLabel(label) {
        if (label === "Completed") {
          return "status-complete";
        }
        if (label === "In Progress") {
          return "status-progress";
        }
        return "status-pending";
      }

      function setRowStatus(row, statusLabel) {
        var statusPill = row.querySelector("[data-status-pill]");
        if (!statusPill) {
          return;
        }
        statusPill.className = "status-pill " + statusClassFromLabel(statusLabel);
        statusPill.textContent = statusLabel;
        row.setAttribute("data-current-status", statusLabel);
      }

      function applyFilters() {
        var selectedTaskType = normalize(taskTypeValue ? taskTypeValue.textContent : "All Task Types");
        var selectedStatus = normalize(taskStatusValue ? taskStatusValue.textContent : "All Statuses");
        var visibleRows = 0;

        assignmentRows.forEach(function (row) {
          var rowTaskType = normalize(row.getAttribute("data-task-type") || (row.cells[3] ? row.cells[3].textContent : ""));
          var rowStatus = normalize(row.getAttribute("data-current-status") || "");
          var matchesTaskType = selectedTaskType === "all task types" || rowTaskType === selectedTaskType;
          var matchesStatus = selectedStatus === "all statuses" || rowStatus === selectedStatus;
          var shouldShow = matchesTaskType && matchesStatus;

          row.hidden = !shouldShow;
          if (shouldShow) {
            visibleRows += 1;
          }
        });

        if (assignmentEmptyRow) {
          assignmentEmptyRow.hidden = visibleRows !== 0;
        }
      }

      function updateSummary() {
        var pending = 0;
        var inProgress = 0;
        var completed = 0;

        assignmentRows.forEach(function (row) {
          if (row.hidden) {
            return;
          }

          var statusPill = row.querySelector("[data-status-pill]");
          var statusText = statusPill ? statusPill.textContent.trim() : "";
          if (statusText === "Completed") {
            completed += 1;
          } else if (statusText === "In Progress") {
            inProgress += 1;
          } else {
            pending += 1;
          }
        });

        var total = pending + inProgress + completed;
        if (totalTasksPill) {
          totalTasksPill.textContent = String(total) + " Total Tasks";
        }
        if (pendingCountEl) {
          pendingCountEl.textContent = String(pending);
        }
        if (inProgressCountEl) {
          inProgressCountEl.textContent = String(inProgress);
        }
        if (completedCountEl) {
          completedCountEl.textContent = String(completed);
        }
      }

      function applyRowState(row) {
        var actionSelect = row.querySelector("[data-action-select]");
        var statusPill = row.querySelector("[data-status-pill]");
        var progressValue = row.querySelector("[data-progress-value]");
        var progressFill = row.querySelector("[data-progress-fill]");

        if (!actionSelect || !statusPill) {
          return;
        }

        var defaultPercent = clampPercent(parseInt(row.getAttribute("data-default-progress"), 10), 0, 99);
        var percent = actionSelect.value === "complete" ? 100 : defaultPercent;

        if (progressValue) {
          progressValue.textContent = String(percent) + "%";
        }

        var statusLabel = "Pending";
        if (percent >= 100) {
          statusLabel = "Completed";
        } else if (percent > 0) {
          statusLabel = "In Progress";
        }

        setRowStatus(row, statusLabel);

        if (progressFill) {
          progressFill.style.width = String(percent) + "%";
        }
      }

      selectWrappers.forEach(function (wrapper) {
        var trigger = wrapper.querySelector(".select-trigger");
        var valueLabel = wrapper.querySelector(".select-trigger span");
        var options = wrapper.querySelectorAll(".select-option");

        if (!trigger || !options.length || !valueLabel) {
          return;
        }

        trigger.addEventListener("click", function () {
          var willOpen = !wrapper.classList.contains("open");
          closeAll(wrapper);
          wrapper.classList.toggle("open", willOpen);
          trigger.setAttribute("aria-expanded", String(willOpen));
        });

        options.forEach(function (option) {
          option.addEventListener("click", function () {
            options.forEach(function (item) {
              item.classList.remove("active");
            });

            option.classList.add("active");
            valueLabel.textContent = option.getAttribute("data-value") || option.textContent.trim();
            wrapper.classList.remove("open");
            trigger.setAttribute("aria-expanded", "false");
            applyFilters();
            updateSummary();
          });
        });
      });

      assignmentRows.forEach(function (row) {
        var actionSelect = row.querySelector("[data-action-select]");

        if (actionSelect) {
          actionSelect.addEventListener("change", function () {
            applyRowState(row);
            applyFilters();
            updateSummary();
          });
        }

        applyRowState(row);
      });

      document.addEventListener("click", function (event) {
        if (!event.target.closest("[data-select]")) {
          closeAll(null);
        }
      });

      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          closeAll(null);
        }
      });

      applyFilters();
      updateSummary();
    }());
  </script>
</body>
</html>
