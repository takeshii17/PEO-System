{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'styles.css' %}">
    <title>Planning Division Dashboard</title>
    
</head>
<body class="view-planning">
    <div class="layout">
        <aside class="sidebar">
            <div class="brand">
                <div class="logo">PEO</div>
                <div>
                    <h1>PEO Portal</h1>
                    <p>Workflow Management</p>
                </div>
            </div>

            <nav class="nav">
                <a href="{% url 'home' %}">
                    <svg viewBox="0 0 24 24" fill="none"><rect x="3" y="3" width="7" height="7" rx="1.8" stroke="currentColor" stroke-width="2"/><rect x="14" y="3" width="7" height="7" rx="1.8" stroke="currentColor" stroke-width="2"/><rect x="3" y="14" width="7" height="7" rx="1.8" stroke="currentColor" stroke-width="2"/><rect x="14" y="14" width="7" height="7" rx="1.8" stroke="currentColor" stroke-width="2"/></svg>
                    Dashboard
                </a>
                <a href="{% url 'admin_div_dashboard' %}">
                    <svg viewBox="0 0 24 24" fill="none"><path d="M7 20v-2a4 4 0 0 1 4-4h2a4 4 0 0 1 4 4v2" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2"/></svg>
                    Admin Division
                </a>
                <a href="{% url 'planning_div_dashboard' %}" class="active">
                    <svg viewBox="0 0 24 24" fill="none"><rect x="5" y="3" width="14" height="18" rx="2" stroke="currentColor" stroke-width="2"/><path d="M9 7h6M9 11h6M9 15h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                    Planning Division
                    <span class="caret">&#8250;</span>
                </a>
                <a href="{% url 'construction_div_dashboard' %}">
                    <svg viewBox="0 0 24 24" fill="none"><path d="M14 5 5 14l-1 5 5-1 9-9-4-4Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></svg>
                    Construction Division
                </a>
                <a href="{% url 'quality_div_dashboard' %}">
                    <svg viewBox="0 0 24 24" fill="none"><path d="M12 3 5 6v6c0 5 3.5 7.5 7 9 3.5-1.5 7-4 7-9V6l-7-3Z" stroke="currentColor" stroke-width="2"/><path d="m9 12 2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                    Quality Division
                </a>
                <a href="{% url 'maintinance_div_dashboard' %}">
                    <svg viewBox="0 0 24 24" fill="none"><path d="m14 6-8 8 4 4 8-8-4-4Z" stroke="currentColor" stroke-width="2"/><path d="M6 14 4 20l6-2" stroke="currentColor" stroke-width="2"/></svg>
                    Maintenance Division
                </a>
                <a href="{% url 'my_assignments' %}">
                    <svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/><path d="m9.5 12 1.7 1.7L15 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                    My Assignments
                </a>
                <a href="{% url 'maintinance_task_management' %}">
                    <svg viewBox="0 0 24 24" fill="none"><path d="M4 7h7M4 12h12M4 17h9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="17" cy="7" r="2" stroke="currentColor" stroke-width="2"/></svg>
                    Tasks
                </a>
                <a href="{% url 'maintinance_contractor_management' %}">
                    <svg viewBox="0 0 24 24" fill="none"><path d="M3 11h18v8a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-8Z" stroke="currentColor" stroke-width="2"/><path d="M8 11V8a4 4 0 0 1 8 0v3" stroke="currentColor" stroke-width="2"/></svg>
                    Contractors
                </a>
            </nav>
        </aside>

        <div class="content">
            <header class="topbar">
                <div class="title-wrap">
                    <h2>Planning Division</h2>
                    <div class="title-sub">
                        <span class="division-chip">Planning Division</span>
                        <span>Budget Allocation &amp; Program of Works Management</span>
                    </div>
                </div>
                <div class="profile">
                    <div class="seal">OFFICE<br>OF PEA</div>
                    <div class="avatar">L</div>
                    <button class="logout" type="button">Logout</button>
                </div>
            </header>

            <main class="main">
                <section class="section-tabs">
                    <a class="section-tab {% if active_tab == 'budget' %}active{% endif %}" href="{% url 'planning_div_dashboard' %}?tab=budget">
                        <svg viewBox="0 0 24 24" fill="none"><path d="M5 7h14v10a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V7Z" stroke="currentColor" stroke-width="2"/><path d="M9 7V5h6v2M8 12h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                        Budget
                    </a>
                    <a class="section-tab {% if active_tab == 'ppa' %}active{% endif %}" href="{% url 'planning_div_dashboard' %}?tab=ppa{% if selected_fund %}&fund={{ selected_fund }}{% endif %}">
                        <svg viewBox="0 0 24 24" fill="none"><rect x="5" y="3" width="14" height="18" rx="2" stroke="currentColor" stroke-width="2"/><path d="M9 7h6M9 11h6M9 15h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                        PPA
                    </a>
                    <a class="section-tab {% if active_tab == 'timeline' %}active{% endif %}" href="{% url 'planning_div_dashboard' %}?tab=timeline">
                        <svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/><path d="M12 7v5l3 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                        Timeline
                    </a>
                </section>

                {% if active_tab == "budget" %}
                <section class="stats">
                    <article class="card">
                        <div class="card-icon blue">
                            <svg viewBox="0 0 24 24" fill="none"><path d="M5 7h14v10a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V7Z" stroke="currentColor" stroke-width="2"/><path d="M9 7V5h6v2M8 12h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                        </div>
                        <div>
                            <strong>{{ total_budgets }}</strong>
                            <span>Total Budgets</span>
                        </div>
                    </article>
                    <article class="card">
                        <div class="card-icon green">
                            <svg viewBox="0 0 24 24" fill="none"><path d="M12 3v18M16.5 7.5A4.5 4.5 0 0 0 12 5c-2.5 0-4 1.2-4 3s1.5 3 4 3 4 1.2 4 3-1.5 3-4 3a4.5 4.5 0 0 1-4.5-2.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                        </div>
                        <div>
                            <strong>PHP {{ total_allocated|floatformat:0 }}</strong>
                            <span>Total Allocated</span>
                        </div>
                    </article>
                    <article class="card">
                        <div class="card-icon gold">
                            <svg viewBox="0 0 24 24" fill="none"><path d="M6 11h12v5a3 3 0 0 1-3 3H9a3 3 0 0 1-3-3v-5Z" stroke="currentColor" stroke-width="2"/><path d="M7 11V9a5 5 0 0 1 10 0v2M5 13H3M21 13h-2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                        </div>
                        <div>
                            <strong>PHP {{ total_remaining|floatformat:0 }}</strong>
                            <span>Total Remaining</span>
                        </div>
                    </article>
                    <article class="card">
                        <div class="card-icon violet">
                            <svg viewBox="0 0 24 24" fill="none"><path d="M4 16 10 10l4 4 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M20 12V8h-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                        </div>
                        <div>
                            <strong>FY 2026</strong>
                            <span>Current Year</span>
                        </div>
                    </article>
                </section>

                <section class="budget-panel">
                    <div class="panel-head">
                        <div>
                            <h3>Annual Budget Allocations</h3>
                            <p>Budget management</p>
                        </div>
                        <button class="new-budget" type="button">
                            <span>+</span>
                            <span>New Budget</span>
                        </button>
                    </div>

                    {% for budget in budgets %}
                    <article class="budget-item">
                        <div class="item-top">
                            <div>
                                <div class="title-line">
                                    <h4><a href="{% url 'planning_div_dashboard' %}?tab=ppa&fund={{ budget.fund }}">{{ budget.name }}</a></h4>
                                    <span class="status">{{ budget.get_status_display }}</span>
                                </div>
                                <div class="meta">
                                    <div>Total Budget: <strong>PHP {{ budget.total_budget|floatformat:0 }}</strong></div>
                                    <div>Allocated: <strong>PHP {{ budget.allocated_value|floatformat:0 }}</strong></div>
                                    <div>Remaining: <strong class="ok">PHP {{ budget.remaining_amount|floatformat:0 }}</strong></div>
                                </div>
                            </div>
                            <div class="icon-actions">
                                <a class="icon-btn" href="{% url 'planning_div_dashboard' %}?tab=budget&edit_budget={{ budget.id }}" aria-label="Edit">
                                    <svg viewBox="0 0 24 24" fill="none"><path d="m4 20 4.5-1 10-10-3.5-3.5-10 10L4 20Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/><path d="m13.5 6 3.5 3.5" stroke="currentColor" stroke-width="2"/></svg>
                                </a>
                                <form method="post">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="delete_budget">
                                    <input type="hidden" name="delete_id" value="{{ budget.id }}">
                                    <button class="icon-btn" type="submit" aria-label="Delete">
                                        <svg viewBox="0 0 24 24" fill="none"><path d="M5 7h14M9 7V5h6v2M8 7v12m8-12v12M6 7l1 13a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                                    </button>
                                </form>
                            </div>
                        </div>
                        <div class="util-row">
                            <span>Utilization</span>
                            <strong>{{ budget.utilization_percent|floatformat:0 }}%</strong>
                        </div>
                        <div class="progress"><span style="width:{{ budget.utilization_percent|floatformat:0 }}%"></span></div>
                    </article>
                    {% empty %}
                    <article class="budget-item">
                        <div class="meta">No budget records yet.</div>
                    </article>
                    {% endfor %}
                </section>
                {% elif active_tab == "ppa" %}
                <section class="stats">
                    <article class="card">
                        <div class="card-icon blue">
                            <svg viewBox="0 0 24 24" fill="none"><rect x="5" y="3" width="14" height="18" rx="2" stroke="currentColor" stroke-width="2"/><path d="M9 7h6M9 11h6M9 15h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                        </div>
                        <div>
                            <strong>{{ ppa_total }}</strong>
                            <span>Total POWs</span>
                        </div>
                    </article>
                    <article class="card">
                        <div class="card-icon green">
                            <svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/><path d="m8.5 12 2.2 2.2L15.5 9.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                        </div>
                        <div>
                            <strong>{{ ppa_approved }}</strong>
                            <span>Approved</span>
                        </div>
                    </article>
                    <article class="card">
                        <div class="card-icon gold">
                            <svg viewBox="0 0 24 24" fill="none"><path d="M12 8v5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="12" cy="16.5" r=".8" fill="currentColor"/><path d="M10 3h4l7 14H3L10 3Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></svg>
                        </div>
                        <div>
                            <strong>{{ ppa_for_review }}</strong>
                            <span>For Review</span>
                        </div>
                    </article>
                    <article class="card">
                        <div class="card-icon violet">
                            <svg viewBox="0 0 24 24" fill="none"><path d="M12 3v18M16.5 7.5A4.5 4.5 0 0 0 12 5c-2.5 0-4 1.2-4 3s1.5 3 4 3 4 1.2 4 3-1.5 3-4 3a4.5 4.5 0 0 1-4.5-2.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                        </div>
                        <div>
                            <strong>PHP {{ ppa_total_cost|floatformat:0 }}</strong>
                            <span>Total Cost</span>
                        </div>
                    </article>
                </section>

                <section class="budget-panel">
                    <div class="panel-head">
                        <div>
                            <h3>Program of Works</h3>
                            <p>Infrastructure projects linked to approved budgets</p>
                        </div>
                    </div>
                    <div class="pow-toolbar">
                        <form class="pow-tools" method="get">
                            <input type="hidden" name="tab" value="ppa">
                            <input type="text" name="q" value="{{ ppa_search }}" placeholder="Search..." />
                            <select name="status">
                                <option value="">All Statuses</option>
                                {% for value, label in project_status_choices %}
                                <option value="{{ value }}" {% if ppa_status == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                            <select name="fund_filter">
                                <option value="">All Funds</option>
                                {% for value, label in fund_choices %}
                                <option value="{{ value }}" {% if ppa_fund == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                            <button class="icon-btn" type="submit" aria-label="Apply">Go</button>
                        </form>
                        <button class="new-budget" type="button" id="openProjectModal"><span>+</span><span>New POW</span></button>
                    </div>
                    {% if ppa_projects %}
                    <table class="pow-table">
                        <thead>
                            <tr>
                                <th>Project Title</th>
                                <th>Fund</th>
                                <th>Budget Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for project in ppa_projects %}
                            <tr>
                                <td>{{ project.project_title }}</td>
                                <td>{{ project.get_fund_display }}</td>
                                <td>PHP {{ project.budget_amount|floatformat:0 }}</td>
                                <td>{{ project.get_status_display }}</td>
                                <td>
                                    <form method="post">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="delete_project">
                                        <input type="hidden" name="project_id" value="{{ project.id }}">
                                        <button class="icon-btn" type="submit" aria-label="Delete">
                                            <svg viewBox="0 0 24 24" fill="none"><path d="M5 7h14M9 7V5h6v2M8 7v12m8-12v12M6 7l1 13a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="pow-empty">No POWs found. Create a budget first, then add POWs.</div>
                    {% endif %}
                </section>
                {% else %}
                <section class="budget-panel">
                    <div class="panel-head">
                        <div>
                            <h3>Timeline</h3>
                            <p>Timeline tracking view is not configured yet.</p>
                        </div>
                    </div>
                </section>
                {% endif %}
            </main>
        </div>
    </div>
    <div class="modal {% if show_project_modal %}show{% endif %}" id="projectModal">
        <div class="modal-card">
            <div class="modal-head">
                <h3>New POW Project</h3>
                <button class="icon-btn" type="button" id="closeProjectModal" aria-label="Close">X</button>
            </div>
            <div class="modal-body">
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="create_project">
                    <div class="budget-form-grid">
                        <div class="form-field full"><label>Project Title</label>{{ project_form.project_title }}</div>
                        <div class="form-field"><label>Fund Category</label>{{ project_form.fund }}</div>
                        <div class="form-field"><label>Budget Amount</label>{{ project_form.budget_amount }}</div>
                        <div class="form-field full"><label>Status</label>{{ project_form.status }}</div>
                    </div>
                    <div class="modal-actions">
                        <a class="icon-btn" href="{% url 'planning_div_dashboard' %}?tab=ppa{% if selected_fund %}&fund={{ selected_fund }}{% endif %}" aria-label="Cancel">Cancel</a>
                        <button class="new-budget" type="submit">Save Project</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal {% if show_budget_modal %}show{% endif %}" id="budgetModal">
        <div class="modal-card">
            <div class="modal-head">
                <h3>Edit Budget</h3>
                <button class="icon-btn" type="button" id="closeBudgetModal" aria-label="Close">X</button>
            </div>
            <div class="modal-body">
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="update_budget">
                    {% if editing_budget %}
                    <input type="hidden" name="budget_id" value="{{ editing_budget.id }}">
                    {% endif %}
                    <div class="budget-form-grid">
                        <div class="form-field full"><label>Name</label>{{ budget_form.name }}</div>
                        <div class="form-field"><label>Fund</label>{{ budget_form.fund }}</div>
                        <div class="form-field"><label>Fiscal Year</label>{{ budget_form.fiscal_year }}</div>
                        <div class="form-field"><label>Total Budget</label>{{ budget_form.total_budget }}</div>
                        <div class="form-field"><label>Allocated Amount</label><input type="text" value="Auto-computed from POW projects" disabled></div>
                        <div class="form-field full"><label>Status</label>{{ budget_form.status }}</div>
                    </div>
                    <div class="modal-actions">
                        <a class="icon-btn" href="{% url 'planning_div_dashboard' %}?tab=budget" aria-label="Cancel">Cancel</a>
                        <button class="new-budget" type="submit">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        (function () {
            const projectModal = document.getElementById("projectModal");
            const openProjectBtn = document.getElementById("openProjectModal");
            const closeProjectBtn = document.getElementById("closeProjectModal");
            const modal = document.getElementById("budgetModal");
            const closeBtn = document.getElementById("closeBudgetModal");
            const shell = document.querySelector(".app-shell, .layout");
            const sidebar = document.querySelector(".sidebar");
            const sidebarToggleBtn = document.getElementById("sidebarToggleBtn");
            const topbar = document.querySelector(".topbar");
            const sidebarStorageKey = "peo_sidebar_collapsed";

            function applySidebarState(isCollapsed) {
                if (!shell) return;
                shell.classList.toggle("sidebar-collapsed", isCollapsed);
                if (sidebarToggleBtn) {
                    sidebarToggleBtn.setAttribute("aria-expanded", String(!isCollapsed));
                    sidebarToggleBtn.setAttribute("aria-label", isCollapsed ? "Show sidebar" : "Hide sidebar");
                }
            }

            if (shell && sidebar) {
                const sidebarVisible = window.getComputedStyle(sidebar).display !== "none";
                if (!sidebarVisible) {
                    if (sidebarToggleBtn) sidebarToggleBtn.style.display = "none";
                } else {
                    if (sidebarToggleBtn) sidebarToggleBtn.style.display = "none";
                    const isMobileLayout = window.matchMedia("(max-width: 980px)").matches;
                    const storedCollapsed = window.localStorage.getItem(sidebarStorageKey) === "1";
                    applySidebarState(!isMobileLayout && storedCollapsed);

                    const autoHideDelayMs = 5000;
                    let autoHideTimer = null;
                    let lastMouseX = null;

                    function isDesktopAutoMode() {
                        return !window.matchMedia("(max-width: 980px)").matches;
                    }

                    function clearAutoHideTimer() {
                        if (autoHideTimer) {
                            window.clearTimeout(autoHideTimer);
                            autoHideTimer = null;
                        }
                    }

                    function expandSidebar() {
                        if (!shell.classList.contains("sidebar-collapsed")) return;
                        applySidebarState(false);
                        window.localStorage.setItem(sidebarStorageKey, "0");
                    }

                    function collapseSidebar() {
                        if (shell.classList.contains("sidebar-collapsed")) return;
                        applySidebarState(true);
                        window.localStorage.setItem(sidebarStorageKey, "1");
                    }

                    function restartAutoHideTimer() {
                        clearAutoHideTimer();
                        if (!isDesktopAutoMode()) return;
                        if (shell.classList.contains("sidebar-collapsed")) return;
                        autoHideTimer = window.setTimeout(collapseSidebar, autoHideDelayMs);
                    }

                    function handlePointerActivity(event) {
                        if (!isDesktopAutoMode()) return;
                        const currentX = typeof event.clientX === "number" ? event.clientX : lastMouseX;
                        const movingLeft = typeof currentX === "number" && typeof lastMouseX === "number" && currentX < (lastMouseX - 4);
                        const pointerInsideSidebar = sidebar.contains(event.target);
                        const nearLeftEdge = typeof currentX === "number" && currentX <= 80;
                        if (pointerInsideSidebar || nearLeftEdge || movingLeft) {
                            expandSidebar();
                        }
                        restartAutoHideTimer();
                        if (typeof currentX === "number") {
                            lastMouseX = currentX;
                        }
                    }

                    document.addEventListener("mousemove", handlePointerActivity);
                    document.addEventListener("mousedown", handlePointerActivity);
                    document.addEventListener("keydown", restartAutoHideTimer);
                    document.addEventListener("wheel", restartAutoHideTimer, { passive: true });
                    window.addEventListener("focus", restartAutoHideTimer);

                    window.addEventListener("resize", function () {
                        clearAutoHideTimer();
                        lastMouseX = null;
                        if (window.matchMedia("(max-width: 980px)").matches) {
                            applySidebarState(false);
                            return;
                        }
                        const collapsedState = window.localStorage.getItem(sidebarStorageKey) === "1";
                        applySidebarState(collapsedState);
                        restartAutoHideTimer();
                    });

                    restartAutoHideTimer();
                }
            }

            if (openProjectBtn && projectModal) {
                openProjectBtn.addEventListener("click", function () {
                    projectModal.classList.add("show");
                });
            }
            if (closeProjectBtn) {
                closeProjectBtn.addEventListener("click", function () {
                    window.location.href = "{% url 'planning_div_dashboard' %}?tab=ppa{% if selected_fund %}&fund={{ selected_fund }}{% endif %}";
                });
            }
            if (projectModal) {
                projectModal.addEventListener("click", function (event) {
                    if (event.target === projectModal) {
                        window.location.href = "{% url 'planning_div_dashboard' %}?tab=ppa{% if selected_fund %}&fund={{ selected_fund }}{% endif %}";
                    }
                });
            }
            if (closeBtn) {
                closeBtn.addEventListener("click", function () {
                    window.location.href = "{% url 'planning_div_dashboard' %}?tab=budget";
                });
            }
            if (modal) {
                modal.addEventListener("click", function (event) {
                    if (event.target === modal) {
                        window.location.href = "{% url 'planning_div_dashboard' %}?tab=budget";
                    }
                });
            }
        })();
    </script>
</body>
</html>
