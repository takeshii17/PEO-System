{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'styles.css' %}">
    <title>PEO Portal - Construction Division</title>
    
</head>
<body class="view-construction">
<div class="app-shell">
    <aside class="sidebar">
        <div class="brand">
            <div class="brand-logo">PEO</div>
            <div><h1>PEO Portal</h1><p>Workflow Management</p></div>
        </div>
        <nav class="nav-menu">
            <a class="nav-item" href="{% url 'home' %}">Dashboard</a>
            <a class="nav-item" href="{% url 'admin_div_dashboard' %}">Admin Division</a>
            <a class="nav-item" href="{% url 'planning_div_dashboard' %}">Planning Division</a>
            <a class="nav-item active" href="{% url 'construction_div_dashboard' %}">Construction Division</a>
            <a class="nav-item" href="{% url 'quality_div_dashboard' %}">Quality Division</a>
            <a class="nav-item" href="{% url 'maintinance_div_dashboard' %}">Maintenance Division</a>
        </nav>
    </aside>

    <div class="workspace">
        <header class="topbar">
            <div class="account">
                <div class="seal">OFFICE<br>OF PEO</div>
                <div class="avatar">{{ user.username|slice:":1"|upper }}</div>
                <form class="logout-form" action="{% url 'logout' %}" method="post">{% csrf_token %}<button class="logout-btn" type="submit">Logout</button></form>
            </div>
        </header>

        <main class="page">
            <h2>Construction Division</h2>
            <div class="subhead"><span class="chip">Construction Division</span><span>Project Implementation &amp; Supervision</span></div>
            <section class="card">
                <h3>Physical Accomplishment Status Report</h3>
                <div class="toolbar">
                    <button class="btn" type="button" id="openReportModal">+ Add Record</button>
                </div>
                <table class="column-table">
                    <thead>
                        <tr>
                            <th rowspan="2">#</th>
                            <th rowspan="2">Project Name</th>
                            <th rowspan="2">Location</th>
                            <th rowspan="2">MUN</th>
                            <th rowspan="2">Contractor</th>
                            <th rowspan="2">Contract Cost</th>
                            <th rowspan="2">NTP Date</th>
                            <th rowspan="2">C.D</th>
                            <th colspan="3">Contract Period</th>
                            <th rowspan="2">Date Completed</th>
                            <th rowspan="2">Revised Contract Cost</th>
                            <th colspan="2">Status (%) DECEMBER 2025</th>
                            <th rowspan="2">% of Time Elapsed</th>
                            <th rowspan="2">Slippage (+) (-) %</th>
                            <th rowspan="2">Remarks</th>
                            <th rowspan="2">Actions</th>
                        </tr>
                        <tr>
                            <th>Original Expiry Date</th>
                            <th>Add'l. C.D</th>
                            <th>Revised Expiry Date</th>
                            <th>Previous</th>
                            <th>Current</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for report in reports %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ report.project_name }}</td>
                            <td>{{ report.location|default:"-" }}</td>
                            <td>{{ report.mun|default:"-" }}</td>
                            <td>{{ report.contractor|default:"-" }}</td>
                            <td>{% if report.contract_cost %}{{ report.contract_cost }}{% else %}-{% endif %}</td>
                            <td>{% if report.ntp_date %}{{ report.ntp_date|date:"d-M-Y" }}{% else %}-{% endif %}</td>
                            <td>{{ report.cd|default:"-" }}</td>
                            <td>{% if report.original_expiry_date %}{{ report.original_expiry_date|date:"d-M-Y" }}{% else %}-{% endif %}</td>
                            <td>{{ report.additional_cd|default:"-" }}</td>
                            <td>{{ report.revised_expiry_date|default:"-" }}</td>
                            <td>{% if report.date_completed %}{{ report.date_completed|date:"d-M-Y" }}{% else %}-{% endif %}</td>
                            <td>{% if report.revised_contract_cost %}{{ report.revised_contract_cost }}{% else %}-{% endif %}</td>
                            <td>{{ report.status_previous|default:"-" }}</td>
                            <td>{{ report.status_current|default:"-" }}</td>
                            <td>{% if report.percent_time_elapsed %}{{ report.percent_time_elapsed }}{% else %}-{% endif %}</td>
                            <td>{% if report.slippage_percent %}{{ report.slippage_percent }}{% else %}-{% endif %}</td>
                            <td>{{ report.remarks|default:"-" }}</td>
                            <td>
                                <div class="actions">
                                    <a class="btn light" href="?edit={{ report.id }}">Edit</a>
                                    <form method="post">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="delete">
                                        <input type="hidden" name="delete_id" value="{{ report.id }}">
                                        <button class="btn light" type="submit">Delete</button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="19" class="no-data">No records yet.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </section>
        </main>
    </div>
</div>
<div class="modal {% if show_report_modal %}show{% endif %}" id="reportModal">
    <div class="modal-card">
        <div class="modal-head">
            <h3>{% if editing_report %}Edit Report Record{% else %}Create Report Record{% endif %}</h3>
            <button class="btn light" type="button" id="closeReportModal">Close</button>
        </div>
        <div class="modal-body">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="{% if editing_report %}update{% else %}create{% endif %}">
                {% if editing_report %}
                <input type="hidden" name="report_id" value="{{ editing_report.id }}">
                {% endif %}
                <div class="form-grid">
                    <div class="field"><label>Project Name *</label>{{ report_form.project_name }}</div>
                    <div class="field"><label>Location</label>{{ report_form.location }}</div>
                    <div class="field"><label>MUN</label>{{ report_form.mun }}</div>
                    <div class="field"><label>Contractor</label>{{ report_form.contractor }}</div>
                    <div class="field"><label>Contract Cost</label>{{ report_form.contract_cost }}</div>
                    <div class="field"><label>NTP Date</label>{{ report_form.ntp_date }}</div>
                    <div class="field"><label>C.D</label>{{ report_form.cd }}</div>
                    <div class="field"><label>Original Expiry Date</label>{{ report_form.original_expiry_date }}</div>
                    <div class="field"><label>Add'l. C.D</label>{{ report_form.additional_cd }}</div>
                    <div class="field"><label>Revised Expiry Date</label>{{ report_form.revised_expiry_date }}</div>
                    <div class="field"><label>Date Completed</label>{{ report_form.date_completed }}</div>
                    <div class="field"><label>Revised Contract Cost</label>{{ report_form.revised_contract_cost }}</div>
                    <div class="field"><label>Previous</label>{{ report_form.status_previous }}</div>
                    <div class="field"><label>Current</label>{{ report_form.status_current }}</div>
                    <div class="field"><label>% of Time Elapsed</label>{{ report_form.percent_time_elapsed }}</div>
                    <div class="field"><label>Slippage (+) (-) %</label>{{ report_form.slippage_percent }}</div>
                    <div class="field wide"><label>Remarks</label>{{ report_form.remarks }}</div>
                </div>
                <div class="modal-actions">
                    <button class="btn light" type="button" id="cancelReportModal">Cancel</button>
                    <button class="btn" type="submit">{% if editing_report %}Update{% else %}Create{% endif %}</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    (function () {
        const modal = document.getElementById("reportModal");
        const openBtn = document.getElementById("openReportModal");
        const closeBtn = document.getElementById("closeReportModal");
        const cancelBtn = document.getElementById("cancelReportModal");
        const shell = document.querySelector(".app-shell, .layout");
        const sidebar = document.querySelector(".sidebar");
        const sidebarToggleBtn = document.getElementById("sidebarToggleBtn");
        const topbar = document.querySelector(".topbar");
        const sidebarStorageKey = "peo_sidebar_collapsed";

        function applySidebarState(isCollapsed) {
            if (!shell) return;
            shell.classList.toggle("sidebar-collapsed", isCollapsed);
            if (sidebarToggleBtn) {
                sidebarToggleBtn.setAttribute("aria-expanded", String(!isCollapsed));
                sidebarToggleBtn.setAttribute("aria-label", isCollapsed ? "Show sidebar" : "Hide sidebar");
            }
        }

        if (shell && sidebar) {
            const sidebarVisible = window.getComputedStyle(sidebar).display !== "none";
            if (!sidebarVisible) {
                if (sidebarToggleBtn) sidebarToggleBtn.style.display = "none";
            } else {
                if (sidebarToggleBtn) sidebarToggleBtn.style.display = "none";
                const isMobileLayout = window.matchMedia("(max-width: 980px)").matches;
                const storedCollapsed = window.localStorage.getItem(sidebarStorageKey) === "1";
                applySidebarState(!isMobileLayout && storedCollapsed);

                const autoHideDelayMs = 5000;
                let autoHideTimer = null;
                let lastMouseX = null;

                function isDesktopAutoMode() {
                    return !window.matchMedia("(max-width: 980px)").matches;
                }

                function clearAutoHideTimer() {
                    if (autoHideTimer) {
                        window.clearTimeout(autoHideTimer);
                        autoHideTimer = null;
                    }
                }

                function expandSidebar() {
                    if (!shell.classList.contains("sidebar-collapsed")) return;
                    applySidebarState(false);
                    window.localStorage.setItem(sidebarStorageKey, "0");
                }

                function collapseSidebar() {
                    if (shell.classList.contains("sidebar-collapsed")) return;
                    applySidebarState(true);
                    window.localStorage.setItem(sidebarStorageKey, "1");
                }

                function restartAutoHideTimer() {
                    clearAutoHideTimer();
                    if (!isDesktopAutoMode()) return;
                    if (shell.classList.contains("sidebar-collapsed")) return;
                    autoHideTimer = window.setTimeout(collapseSidebar, autoHideDelayMs);
                }

                function handlePointerActivity(event) {
                    if (!isDesktopAutoMode()) return;
                    const currentX = typeof event.clientX === "number" ? event.clientX : lastMouseX;
                    const movingLeft = typeof currentX === "number" && typeof lastMouseX === "number" && currentX < (lastMouseX - 4);
                    const pointerInsideSidebar = sidebar.contains(event.target);
                    const nearLeftEdge = typeof currentX === "number" && currentX <= 80;
                    if (pointerInsideSidebar || nearLeftEdge || movingLeft) {
                        expandSidebar();
                    }
                    restartAutoHideTimer();
                    if (typeof currentX === "number") {
                        lastMouseX = currentX;
                    }
                }

                document.addEventListener("mousemove", handlePointerActivity);
                document.addEventListener("mousedown", handlePointerActivity);
                document.addEventListener("keydown", restartAutoHideTimer);
                document.addEventListener("wheel", restartAutoHideTimer, { passive: true });
                window.addEventListener("focus", restartAutoHideTimer);

                window.addEventListener("resize", function () {
                    clearAutoHideTimer();
                    lastMouseX = null;
                    if (window.matchMedia("(max-width: 980px)").matches) {
                        applySidebarState(false);
                        return;
                    }
                    const collapsedState = window.localStorage.getItem(sidebarStorageKey) === "1";
                    applySidebarState(collapsedState);
                    restartAutoHideTimer();
                });

                restartAutoHideTimer();
            }
        }

        function openModal() { modal.classList.add("show"); }
        function closeModal() { modal.classList.remove("show"); }
        if (openBtn) openBtn.addEventListener("click", openModal);
        if (closeBtn) closeBtn.addEventListener("click", closeModal);
        if (cancelBtn) cancelBtn.addEventListener("click", closeModal);
        if (modal) {
            modal.addEventListener("click", function (event) {
                if (event.target === modal) closeModal();
            });
        }
    })();
</script>
</body>
</html>
