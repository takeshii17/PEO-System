{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{% static 'CSS/styles.css' %}">
  <title>Task Management</title>
  <style>
    :root {
      --bg: #edf1f5;
      --panel: #f8fafc;
      --line: #cfd6df;
      --text: #10233a;
      --muted: #586d84;
      --brand: #133b64;
      --shadow: 0 1px 8px rgba(16, 38, 64, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Sora", "Segoe UI", sans-serif;
      color: var(--text);
      background: var(--bg);
    }

    body.modal-open {
      overflow: hidden;
    }

    .task-page {
      max-width: 1380px;
      margin: 0 auto;
      min-height: 100vh;
      padding: clamp(12px, 2vw, 24px);
    }

    .task-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .task-title {
      margin: 0;
      font-size: clamp(1.45rem, 2vw, 2.1rem);
      line-height: 1.15;
      color: #162739;
    }

    .task-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 14px;
      font: inherit;
      font-size: 0.96rem;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      background: #f7fafd;
      color: #22374f;
    }

    .btn svg {
      width: 18px;
      height: 18px;
    }

    .btn-primary {
      border-color: #0f375d;
      background: var(--brand);
      color: #fff;
      font-weight: 600;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }

    .stat-card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      min-height: 102px;
      padding: 14px;
      box-shadow: var(--shadow);
    }

    .stat-value {
      margin: 0;
      font-size: 2rem;
      font-weight: 700;
      line-height: 1;
      color: #0f2a46;
    }

    .stat-label {
      margin: 8px 0 0;
      color: #576c84;
      font-size: 0.98rem;
    }

    .filters-panel {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 12px;
      margin-bottom: 12px;
    }

    .filter-row {
      display: grid;
      grid-template-columns: minmax(220px, 1fr) repeat(3, minmax(150px, 190px));
      gap: 10px;
    }

    .search-box,
    .field-select {
      border: 1px solid #cad2dc;
      border-radius: 12px;
      min-height: 44px;
      background: #fbfdff;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 12px;
    }

    .search-box svg {
      width: 18px;
      height: 18px;
      color: #67809c;
      flex: 0 0 auto;
    }

    .search-box input,
    .field-select select {
      border: 0;
      outline: none;
      background: transparent;
      width: 100%;
      font: inherit;
      color: #2f4a66;
      font-size: 0.97rem;
    }

    .tasks-table-panel {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 12px;
    }

    .table-head {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .table-head h3 {
      margin: 0;
      font-size: clamp(1.2rem, 1.4vw, 1.6rem);
    }

    .table-head p {
      margin: 0;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .table-wrap {
      overflow-x: auto;
      border: 1px solid #d2d9e1;
      border-radius: 12px;
      background: #fff;
    }

    .task-record-overlay {
      position: fixed;
      inset: 0;
      background: rgba(7, 18, 30, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 980;
    }

    .task-record-overlay.open {
      display: flex;
    }

    .task-float-card {
      border: 1px solid #b7c5d5;
      border-radius: 14px;
      background: #f2f5f8;
      box-shadow: 0 10px 22px rgba(20, 40, 62, 0.12);
      width: min(1120px, 96vw);
      max-height: calc(100vh - 40px);
      overflow: auto;
    }

    .task-float-head {
      border-bottom: 1px solid #c7d2df;
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .task-float-title {
      margin: 0;
      font-size: 1.05rem;
      color: #23364d;
      font-weight: 700;
      letter-spacing: 0.01em;
    }

    .task-float-body {
      padding: 12px 16px 14px;
    }

    .task-float-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(150px, 1fr));
      gap: 10px 12px;
      align-items: end;
    }

    .task-float-field {
      display: grid;
      gap: 5px;
    }

    .task-float-field.full {
      grid-column: 1 / -1;
    }

    .task-float-field > span {
      color: #344c67;
      font-size: 0.86rem;
      font-weight: 700;
      letter-spacing: 0.01em;
      white-space: nowrap;
    }

    .task-float-actions {
      margin-top: 12px;
      display: grid;
      grid-template-columns: repeat(2, minmax(160px, 1fr));
      gap: 10px;
    }

    .tasks-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 860px;
    }

    .tasks-table th,
    .tasks-table td {
      text-align: left;
      padding: 11px 12px;
      border-bottom: 1px solid #e0e5eb;
      font-size: 0.95rem;
      vertical-align: top;
    }

    .tasks-table th {
      background: #f4f7fa;
      color: #1a324c;
      font-size: 0.9rem;
      letter-spacing: 0.01em;
      white-space: nowrap;
    }

    .tasks-table tbody tr:last-child td {
      border-bottom: 0;
    }

    .task-cell-input,
    .task-cell-select,
    .task-cell-date {
      width: 100%;
      min-height: 40px;
      border: 1px solid #b8c8d9;
      border-radius: 10px;
      background: #ffffff;
      padding: 0 10px;
      font: inherit;
      font-size: 0.96rem;
      color: #2a445f;
      outline: none;
    }

    #nextTaskId {
      font-weight: 700;
      color: #1f3f60;
      background: #edf3f9;
    }

    .task-cell-select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none'%3E%3Cpath d='m6 9 6 6 6-6' stroke='%23798ba0' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 30px;
    }

    .task-cell-textarea {
      width: 100%;
      min-height: 82px;
      border: 1px solid #b8c8d9;
      border-radius: 10px;
      background: #ffffff;
      padding: 10px;
      font: inherit;
      font-size: 0.95rem;
      color: #2a445f;
      resize: vertical;
      outline: none;
    }

    .task-cell-input:focus,
    .task-cell-select:focus,
    .task-cell-date:focus,
    .task-cell-textarea:focus {
      border-color: #4f6b88;
      box-shadow: 0 0 0 2px rgba(53, 86, 120, 0.2);
    }

    .task-inline-btn {
      border: 1px solid #153a5f;
      border-radius: 11px;
      min-height: 46px;
      padding: 0 12px;
      background: #f2f5f8;
      color: #153a5f;
      font: inherit;
      font-size: 1.02rem;
      font-weight: 600;
      cursor: pointer;
    }

    .task-inline-btn.save {
      border-color: #153a5f;
      background: #153a5f;
      color: #fff;
    }

    .empty-row td {
      text-align: center;
      color: #637a92;
      padding: 28px 16px;
      font-size: 1rem;
    }

    .status-pill {
      display: inline-block;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.82rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .status-pending {
      background: #fdecc5;
      color: #9a5b00;
    }

    .status-progress {
      background: #d8e9ff;
      color: #1458c5;
    }

    .status-complete {
      background: #d4f1df;
      color: #0a8744;
    }

    .task-row-actions {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    .task-row-btn {
      border: 1px solid #c5d1de;
      border-radius: 8px;
      min-height: 30px;
      padding: 0 10px;
      background: #f6f9fc;
      color: #1f3e5c;
      font: inherit;
      font-size: 0.84rem;
      font-weight: 600;
      cursor: pointer;
    }

    .task-row-btn:hover {
      background: #ecf2f8;
    }

    .task-row-btn.delete {
      border-color: #edc5cd;
      background: #fff5f7;
      color: #b4233f;
    }

    .task-row-btn.delete:hover {
      background: #ffecef;
    }

    .personnel-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(7, 18, 30, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 1000;
    }

    .personnel-modal-overlay.open {
      display: flex;
    }

    .personnel-modal {
      width: min(580px, 100%);
      background: #f3f5f7;
      border-radius: 14px;
      border: 1px solid #d7dde5;
      box-shadow: 0 12px 30px rgba(15, 31, 49, 0.2);
      padding: 20px 22px;
    }

    .personnel-modal-head {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 16px;
    }

    .personnel-modal-head h2 {
      margin: 0;
      font-size: 2rem;
      line-height: 1.1;
      color: #252f3a;
    }

    .personnel-modal-head p {
      margin: 6px 0 0;
      color: #5d6d7f;
      font-size: 1rem;
    }

    .personnel-close {
      width: 30px;
      height: 30px;
      border: 0;
      border-radius: 8px;
      background: transparent;
      color: #4f5b69;
      font-size: 1.5rem;
      line-height: 1;
      cursor: pointer;
    }

    .personnel-close:hover {
      background: rgba(25, 40, 56, 0.08);
    }

    .personnel-form {
      display: grid;
      gap: 12px 14px;
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .personnel-field,
    .personnel-field.full {
      display: grid;
      gap: 6px;
    }

    .personnel-field.full {
      grid-column: 1 / -1;
    }

    .personnel-field span {
      color: #24374b;
      font-size: 0.92rem;
      font-weight: 600;
    }

    .personnel-field input,
    .personnel-field select {
      min-height: 44px;
      border: 1px solid #ccd3dc;
      border-radius: 11px;
      background: #f8fafc;
      padding: 0 12px;
      font: inherit;
      color: #34495f;
      font-size: 0.97rem;
      outline: none;
    }

    .personnel-field input::placeholder {
      color: #697b8f;
    }

    .personnel-field select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none'%3E%3Cpath d='m6 9 6 6 6-6' stroke='%238293a5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 34px;
    }

    .personnel-field input:focus,
    .personnel-field select:focus {
      border-color: #4f667f;
      box-shadow: 0 0 0 2px rgba(47, 84, 120, 0.25);
    }

    .personnel-check {
      display: inline-flex;
      align-items: center;
      align-self: end;
      gap: 8px;
      min-height: 44px;
      color: #24384f;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .personnel-check input {
      width: 18px;
      height: 18px;
      margin: 0;
      accent-color: #264f75;
    }

    .personnel-actions {
      grid-column: 1 / -1;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 8px;
    }

    .personnel-btn {
      border-radius: 11px;
      border: 1px solid #ccd3dc;
      background: #f6f8fb;
      color: #24384f;
      padding: 10px 16px;
      min-height: 42px;
      font: inherit;
      font-weight: 600;
      cursor: pointer;
    }

    .personnel-submit {
      border-color: #153a5f;
      background: #153a5f;
      color: #fff;
    }

    @media (max-width: 980px) {
      .filter-row {
        grid-template-columns: 1fr;
      }

      .task-actions {
        width: 100%;
      }

      .btn {
        flex: 1 1 180px;
        justify-content: center;
      }

      .task-float-grid {
        grid-template-columns: repeat(2, minmax(180px, 1fr));
      }

      .task-float-actions {
        grid-template-columns: 1fr;
      }

      .task-inline-btn {
        width: 100%;
      }
    }

    @media (max-width: 640px) {
      .stats-grid {
        grid-template-columns: 1fr 1fr;
      }

      .task-float-grid {
        grid-template-columns: 1fr;
      }

      .personnel-form {
        grid-template-columns: 1fr;
      }

      .personnel-check {
        align-self: start;
      }

      .personnel-actions {
        justify-content: stretch;
      }

      .personnel-btn {
        flex: 1;
      }
    }
  </style>
</head>
<body{% if request.GET.embedded %} class="embedded-maintenance-view"{% endif %}>
  <main class="task-page">
    <header class="task-header">
      <h1 class="task-title">Task Management</h1>
      <div class="task-actions">
        <button class="btn" type="button" id="openPersonnelModal">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M16 19v-1a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v1M18 8a3 3 0 1 1 0 6M12 8a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          Add Personnel
        </button>
        <button class="btn btn-primary" type="button" id="openTaskFormBtn">
          <span>+</span>
          <span>New Task</span>
        </button>
      </div>
    </header>

    <section class="stats-grid" aria-label="Task summary cards">
      <article class="stat-card"><p class="stat-value">0</p><p class="stat-label">Total Tasks</p></article>
      <article class="stat-card"><p class="stat-value">0</p><p class="stat-label">Pending</p></article>
      <article class="stat-card"><p class="stat-value">0</p><p class="stat-label">In Progress</p></article>
      <article class="stat-card"><p class="stat-value">0</p><p class="stat-label">Completed</p></article>
      <article class="stat-card"><p class="stat-value">0</p><p class="stat-label">Overdue</p></article>
    </section>

    <section class="filters-panel" aria-label="Task filters">
      <div class="filter-row">
        <label class="search-box" for="taskSearch">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="11" cy="11" r="6.5" stroke="currentColor" stroke-width="2"/><path d="M16 16L21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          <input id="taskSearch" type="search" placeholder="Search tasks..." autocomplete="off">
        </label>

        <label class="field-select">
          <select>
            <option>All Divisions</option>
            <option>Admin</option>
            <option>Planning Division</option>
            <option>Construction</option>
            <option>Quality</option>
            <option>Maintenance</option>
          </select>
        </label>

        <label class="field-select">
          <select>
            <option>All Statuses</option>
            <option>Pending</option>
            <option>In Progress</option>
            <option>Completed</option>
            <option>Cancelled</option>
          </select>
        </label>

        <label class="field-select">
          <select>
            <option>All Priorities</option>
            <option>Low</option>
            <option>Medium</option>
            <option>High</option>
            <option>Urgent</option>
          </select>
        </label>
      </div>
    </section>

    <section class="tasks-table-panel" aria-label="Personnel table">
      <div class="table-head">
        <h3>Personnel List</h3>
        <p id="personnelCountText">0 personnel found</p>
      </div>

      <div class="table-wrap">
        <table class="tasks-table">
          <thead>
            <tr>
              <th>Full Name</th>
              <th>Employee ID</th>
              <th>Division</th>
              <th>Position</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Role</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="personnelTableBody">
            <tr id="personnelEmptyRow" class="empty-row">
              <td colspan="8">No personnel found</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <section class="tasks-table-panel" aria-label="Tasks table">
      <div class="table-head">
        <h3>Task List</h3>
        <p id="taskCountText">0 tasks found</p>
      </div>

      <div class="table-wrap">
        <table class="tasks-table">
          <thead>
            <tr>
              <th>Task ID</th>
              <th>Title</th>
              <th>Division</th>
              <th>Assigned To</th>
              <th>Priority</th>
              <th>Status</th>
              <th>Due Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tasksTableBody">
            <tr id="tasksEmptyRow" class="empty-row">
              <td colspan="8">No tasks found</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <div class="task-record-overlay" id="taskRecordOverlay" aria-hidden="true">
    <form id="newTaskFormCard" class="task-float-card">
      <div class="task-float-head">
        <h4 class="task-float-title">Create Task Record</h4>
      </div>
      <div class="task-float-body">
        <div class="task-float-grid">
          <label class="task-float-field">
            <span>Task ID</span>
            <input id="nextTaskId" class="task-cell-input" type="text" readonly>
          </label>

          <label class="task-float-field">
            <span>Task Name *</span>
            <input id="taskTitleInput" class="task-cell-input" type="text" placeholder="e.g., Bridge Rehabilitation Project" required>
          </label>

          <label class="task-float-field">
            <span>Division</span>
            <select id="taskDivisionInput" class="task-cell-select">
              <option value="Maintenance">Maintenance</option>
              <option value="Admin">Admin</option>
              <option value="Planning Division">Planning Division</option>
              <option value="Construction">Construction</option>
              <option value="Quality">Quality</option>
            </select>
          </label>

          <label class="task-float-field">
            <span>Assigned To</span>
            <input id="taskAssignedInput" class="task-cell-input" type="text" placeholder="Personnel name">
          </label>

          <label class="task-float-field">
            <span>Priority</span>
            <select id="taskPriorityInput" class="task-cell-select">
              <option value="Low">Low</option>
              <option value="Medium" selected>Medium</option>
              <option value="High">High</option>
              <option value="Urgent">Urgent</option>
            </select>
          </label>

          <label class="task-float-field">
            <span>Status</span>
            <select id="taskStatusInput" class="task-cell-select">
              <option value="Pending" selected>Pending</option>
              <option value="In Progress">In Progress</option>
              <option value="Completed">Completed</option>
            </select>
          </label>

          <label class="task-float-field">
            <span>Due Date</span>
            <input id="taskDueDateInput" class="task-cell-date" type="date">
          </label>

          <label class="task-float-field">
            <span>Task Owner</span>
            <input class="task-cell-input" type="text" placeholder="e.g., Project Engineer">
          </label>

          <label class="task-float-field full">
            <span>Remarks</span>
            <textarea id="taskRemarksInput" class="task-cell-textarea" placeholder="Additional details"></textarea>
          </label>
        </div>

        <div class="task-float-actions">
          <button id="cancelTaskBtn" class="task-inline-btn" type="button">Cancel</button>
          <button id="saveTaskBtn" class="task-inline-btn save" type="submit">Create</button>
        </div>
      </div>
    </form>
  </div>

  <div class="personnel-modal-overlay" id="personnelModal" aria-hidden="true">
    <div class="personnel-modal" role="dialog" aria-modal="true" aria-labelledby="personnelModalTitle">
      <div class="personnel-modal-head">
        <div>
          <h2 id="personnelModalTitle">Add Personnel</h2>
          <p>Add a new personnel to assign tasks to</p>
        </div>
        <button type="button" class="personnel-close" id="closePersonnelModal" aria-label="Close">&times;</button>
      </div>

      <form class="personnel-form" id="personnelForm">
        <label class="personnel-field full">
          <span>Full Name *</span>
          <input id="personnelFullName" type="text" placeholder="Enter the Name of Personel" required>
        </label>

        <label class="personnel-field">
          <span>Employee ID</span>
          <input id="personnelEmployeeId" type="text" placeholder="e.g., EMP-001">
        </label>

        <label class="personnel-field">
          <span>Division *</span>
          <select id="personnelDivision" required>
            <option value="" selected disabled>Select division</option>
            <option value="Admin">Admin</option>
            <option value="Planning Division">Planning Division</option>
            <option value="Construction">Construction</option>
            <option value="Quality">Quality</option>
            <option value="Maintenance">Maintenance</option>
          </select>
        </label>

        <label class="personnel-field">
          <span>Position</span>
          <input id="personnelPosition" type="text" placeholder="e.g., Engineer II">
        </label>

        <label class="personnel-field">
          <span>Email</span>
          <input id="personnelEmail" type="email" placeholder="e.g., (emailname)@peo.gov.ph">
        </label>

        <label class="personnel-field">
          <span>Phone</span>
          <input id="personnelPhone" type="text" placeholder="e.g., 09171234567">
        </label>

        <label class="personnel-check">
          <input id="personnelIsHead" type="checkbox">
          <span>Division Head</span>
        </label>

        <div class="personnel-actions">
          <button type="button" class="personnel-btn" id="cancelPersonnelModal">Cancel</button>
          <button type="submit" class="personnel-btn personnel-submit" id="personnelSubmitBtn">Add Personnel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      var openTaskFormBtn = document.getElementById("openTaskFormBtn");
      var taskRecordOverlay = document.getElementById("taskRecordOverlay");
      var newTaskFormCard = document.getElementById("newTaskFormCard");
      var tasksTableBody = document.getElementById("tasksTableBody");
      var tasksEmptyRow = document.getElementById("tasksEmptyRow");
      var taskCountText = document.getElementById("taskCountText");
      var nextTaskId = document.getElementById("nextTaskId");
      var taskTitleInput = document.getElementById("taskTitleInput");
      var taskDivisionInput = document.getElementById("taskDivisionInput");
      var taskAssignedInput = document.getElementById("taskAssignedInput");
      var taskPriorityInput = document.getElementById("taskPriorityInput");
      var taskStatusInput = document.getElementById("taskStatusInput");
      var taskDueDateInput = document.getElementById("taskDueDateInput");
      var taskRemarksInput = document.getElementById("taskRemarksInput");
      var saveTaskBtn = document.getElementById("saveTaskBtn");
      var cancelTaskBtn = document.getElementById("cancelTaskBtn");
      var personnelModal = document.getElementById("personnelModal");
      var openPersonnelModalBtn = document.getElementById("openPersonnelModal");
      var closePersonnelModalBtn = document.getElementById("closePersonnelModal");
      var cancelPersonnelModalBtn = document.getElementById("cancelPersonnelModal");
      var personnelForm = document.getElementById("personnelForm");
      var personnelFirstField = document.getElementById("personnelFullName");
      var personnelEmployeeId = document.getElementById("personnelEmployeeId");
      var personnelDivision = document.getElementById("personnelDivision");
      var personnelPosition = document.getElementById("personnelPosition");
      var personnelEmail = document.getElementById("personnelEmail");
      var personnelPhone = document.getElementById("personnelPhone");
      var personnelIsHead = document.getElementById("personnelIsHead");
      var personnelTableBody = document.getElementById("personnelTableBody");
      var personnelEmptyRow = document.getElementById("personnelEmptyRow");
      var personnelCountText = document.getElementById("personnelCountText");
      var personnelModalTitle = document.getElementById("personnelModalTitle");
      var personnelSubmitBtn = document.getElementById("personnelSubmitBtn");
      var taskFormTitle = document.querySelector(".task-float-title");
      var isEditingTask = false;
      var editingTaskRow = null;
      var editingPersonnelRow = null;

      function syncBodyModalLock() {
        var taskModalOpen = taskRecordOverlay && taskRecordOverlay.classList.contains("open");
        var personnelModalOpen = personnelModal && personnelModal.classList.contains("open");
        document.body.classList.toggle("modal-open", Boolean(taskModalOpen || personnelModalOpen));
      }

      function statusClass(status) {
        if (status === "Completed") {
          return "status-complete";
        }
        if (status === "In Progress") {
          return "status-progress";
        }
        return "status-pending";
      }

      function refreshTaskCount() {
        if (!tasksTableBody || !taskCountText) {
          return;
        }

        var count = tasksTableBody.querySelectorAll("tr[data-task-row='1']").length;
        taskCountText.textContent = String(count) + (count === 1 ? " task found" : " tasks found");

        if (tasksEmptyRow) {
          tasksEmptyRow.hidden = count > 0;
        }
      }

      function refreshPersonnelCount() {
        if (!personnelTableBody || !personnelCountText) {
          return;
        }

        var count = personnelTableBody.querySelectorAll("tr[data-personnel-row='1']").length;
        personnelCountText.textContent = String(count) + (count === 1 ? " personnel found" : " personnel found");

        if (personnelEmptyRow) {
          personnelEmptyRow.hidden = count > 0;
        }
      }

      function setPersonnelModalMode(isEditMode) {
        if (personnelModalTitle) {
          personnelModalTitle.textContent = isEditMode ? "Edit Personnel" : "Add Personnel";
        }
        if (personnelSubmitBtn) {
          personnelSubmitBtn.textContent = isEditMode ? "Update Personnel" : "Add Personnel";
        }
      }

      function resetPersonnelFormState() {
        if (personnelForm) {
          personnelForm.reset();
        }
        editingPersonnelRow = null;
        setPersonnelModalMode(false);
      }

      function personnelPayloadFromRow(row) {
        if (!row) {
          return null;
        }

        return {
          fullName: row.getAttribute("data-personnel-full-name") || (row.cells[0] ? row.cells[0].textContent.trim() : ""),
          employeeId: row.getAttribute("data-personnel-id") || (row.cells[1] ? row.cells[1].textContent.trim() : "-"),
          division: row.getAttribute("data-personnel-division") || (row.cells[2] ? row.cells[2].textContent.trim() : ""),
          position: row.getAttribute("data-personnel-position") || (row.cells[3] ? row.cells[3].textContent.trim() : "-"),
          email: row.getAttribute("data-personnel-email") || (row.cells[4] ? row.cells[4].textContent.trim() : "-"),
          phone: row.getAttribute("data-personnel-phone") || (row.cells[5] ? row.cells[5].textContent.trim() : "-"),
          role: row.getAttribute("data-personnel-role") || (row.cells[6] ? row.cells[6].textContent.trim() : "Personnel")
        };
      }

      function applyPersonnelRowPayload(row, payload) {
        if (!row || !payload) {
          return;
        }

        row.setAttribute("data-personnel-row", "1");
        row.setAttribute("data-personnel-full-name", payload.fullName);
        row.setAttribute("data-personnel-id", payload.employeeId);
        row.setAttribute("data-personnel-division", payload.division);
        row.setAttribute("data-personnel-position", payload.position);
        row.setAttribute("data-personnel-email", payload.email);
        row.setAttribute("data-personnel-phone", payload.phone);
        row.setAttribute("data-personnel-role", payload.role);

        row.innerHTML = "";

        function appendCell(value) {
          var cell = document.createElement("td");
          cell.textContent = value;
          row.appendChild(cell);
        }

        appendCell(payload.fullName);
        appendCell(payload.employeeId);
        appendCell(payload.division);
        appendCell(payload.position);
        appendCell(payload.email);
        appendCell(payload.phone);
        appendCell(payload.role);

        var actionsCell = document.createElement("td");
        var actionsWrap = document.createElement("div");
        actionsWrap.className = "task-row-actions";

        var editBtn = document.createElement("button");
        editBtn.type = "button";
        editBtn.className = "task-row-btn";
        editBtn.setAttribute("data-personnel-action", "edit");
        editBtn.textContent = "Edit";

        var deleteBtn = document.createElement("button");
        deleteBtn.type = "button";
        deleteBtn.className = "task-row-btn delete";
        deleteBtn.setAttribute("data-personnel-action", "delete");
        deleteBtn.textContent = "Delete";

        actionsWrap.appendChild(editBtn);
        actionsWrap.appendChild(deleteBtn);
        actionsCell.appendChild(actionsWrap);
        row.appendChild(actionsCell);
      }

      function createPersonnelRow(payload) {
        var row = document.createElement("tr");
        applyPersonnelRowPayload(row, payload);
        return row;
      }

      function getNextTaskId() {
        if (!tasksTableBody) {
          return "TSK-001";
        }

        var maxNumber = 0;
        var rows = tasksTableBody.querySelectorAll("tr[data-task-row='1']");
        rows.forEach(function (row) {
          var taskIdValue = row.getAttribute("data-task-id");
          if (!taskIdValue) {
            var firstCell = row.querySelector("td");
            taskIdValue = firstCell ? firstCell.textContent.trim() : "";
          }

          var match = String(taskIdValue || "").match(/^TSK-(\d+)$/i);
          if (match) {
            var parsed = Number(match[1]);
            if (!Number.isNaN(parsed) && parsed > maxNumber) {
              maxNumber = parsed;
            }
          }
        });

        return "TSK-" + String(maxNumber + 1).padStart(3, "0");
      }

      function resetTaskForm() {
        if (taskTitleInput) {
          taskTitleInput.value = "";
        }
        if (taskDivisionInput) {
          taskDivisionInput.value = "Maintenance";
        }
        if (taskAssignedInput) {
          taskAssignedInput.value = "";
        }
        if (taskPriorityInput) {
          taskPriorityInput.value = "Medium";
        }
        if (taskStatusInput) {
          taskStatusInput.value = "Pending";
        }
        if (taskDueDateInput) {
          taskDueDateInput.value = "";
        }
        if (taskRemarksInput) {
          taskRemarksInput.value = "";
        }
      }

      function getTaskPayloadFromForm() {
        var title = taskTitleInput ? taskTitleInput.value.trim() : "";
        return {
          id: nextTaskId ? nextTaskId.value : "TSK-000",
          title: title,
          division: taskDivisionInput ? taskDivisionInput.value : "Maintenance",
          assigned: taskAssignedInput && taskAssignedInput.value.trim() ? taskAssignedInput.value.trim() : "-",
          priority: taskPriorityInput ? taskPriorityInput.value : "Medium",
          status: taskStatusInput ? taskStatusInput.value : "Pending",
          dueDate: formatDueDate(taskDueDateInput ? taskDueDateInput.value : "")
        };
      }

      function rowPayload(row) {
        if (!row) {
          return null;
        }

        var statusBadge = row.querySelector(".status-pill");
        return {
          id: row.getAttribute("data-task-id") || (row.cells[0] ? row.cells[0].textContent.trim() : "TSK-000"),
          title: row.getAttribute("data-task-title") || (row.cells[1] ? row.cells[1].textContent.trim() : ""),
          division: row.getAttribute("data-task-division") || (row.cells[2] ? row.cells[2].textContent.trim() : "Maintenance"),
          assigned: row.getAttribute("data-task-assigned") || (row.cells[3] ? row.cells[3].textContent.trim() : "-"),
          priority: row.getAttribute("data-task-priority") || (row.cells[4] ? row.cells[4].textContent.trim() : "Medium"),
          status: row.getAttribute("data-task-status") || (statusBadge ? statusBadge.textContent.trim() : "Pending"),
          dueDate: row.getAttribute("data-task-due-date") || (row.cells[6] ? row.cells[6].textContent.trim() : "-")
        };
      }

      function applyRowPayload(row, payload) {
        if (!row || !payload) {
          return;
        }

        row.setAttribute("data-task-row", "1");
        row.setAttribute("data-task-id", payload.id);
        row.setAttribute("data-task-title", payload.title);
        row.setAttribute("data-task-division", payload.division);
        row.setAttribute("data-task-assigned", payload.assigned);
        row.setAttribute("data-task-priority", payload.priority);
        row.setAttribute("data-task-status", payload.status);
        row.setAttribute("data-task-due-date", payload.dueDate);

        row.innerHTML = "";

        function appendTextCell(value) {
          var cell = document.createElement("td");
          cell.textContent = value;
          row.appendChild(cell);
        }

        appendTextCell(payload.id);
        appendTextCell(payload.title);
        appendTextCell(payload.division);
        appendTextCell(payload.assigned);
        appendTextCell(payload.priority);

        var statusCell = document.createElement("td");
        var badge = document.createElement("span");
        badge.className = "status-pill " + statusClass(payload.status);
        badge.textContent = payload.status;
        statusCell.appendChild(badge);
        row.appendChild(statusCell);

        appendTextCell(payload.dueDate);

        var actionsCell = document.createElement("td");
        var actionsWrap = document.createElement("div");
        actionsWrap.className = "task-row-actions";

        var editBtn = document.createElement("button");
        editBtn.type = "button";
        editBtn.className = "task-row-btn";
        editBtn.setAttribute("data-task-action", "edit");
        editBtn.textContent = "Edit";

        var deleteBtn = document.createElement("button");
        deleteBtn.type = "button";
        deleteBtn.className = "task-row-btn delete";
        deleteBtn.setAttribute("data-task-action", "delete");
        deleteBtn.textContent = "Delete";

        actionsWrap.appendChild(editBtn);
        actionsWrap.appendChild(deleteBtn);
        actionsCell.appendChild(actionsWrap);
        row.appendChild(actionsCell);
      }

      function hydrateExistingTaskRows() {
        if (!tasksTableBody) {
          return;
        }

        var rows = tasksTableBody.querySelectorAll("tr");
        rows.forEach(function (row) {
          if (tasksEmptyRow && row === tasksEmptyRow) {
            return;
          }

          var payload = rowPayload(row);
          if (payload) {
            applyRowPayload(row, payload);
          }
        });
      }

      function openTaskForm(taskRow) {
        if (!newTaskFormCard || !taskRecordOverlay) {
          return;
        }

        isEditingTask = Boolean(taskRow);
        editingTaskRow = taskRow || null;

        if (isEditingTask) {
          var payload = rowPayload(taskRow);
          if (nextTaskId) {
            nextTaskId.value = payload.id;
          }
          if (taskTitleInput) {
            taskTitleInput.value = payload.title;
          }
          if (taskDivisionInput) {
            taskDivisionInput.value = payload.division;
          }
          if (taskAssignedInput) {
            taskAssignedInput.value = payload.assigned === "-" ? "" : payload.assigned;
          }
          if (taskPriorityInput) {
            taskPriorityInput.value = payload.priority;
          }
          if (taskStatusInput) {
            taskStatusInput.value = payload.status;
          }
          if (taskDueDateInput) {
            taskDueDateInput.value = payload.dueDate === "-" ? "" : payload.dueDate;
          }
          if (taskFormTitle) {
            taskFormTitle.textContent = "Edit Task Record";
          }
          if (saveTaskBtn) {
            saveTaskBtn.textContent = "Update";
          }
        } else {
          resetTaskForm();
          if (nextTaskId) {
            nextTaskId.value = getNextTaskId();
          }
          if (taskFormTitle) {
            taskFormTitle.textContent = "Create Task Record";
          }
          if (saveTaskBtn) {
            saveTaskBtn.textContent = "Create";
          }
        }

        taskRecordOverlay.classList.add("open");
        taskRecordOverlay.setAttribute("aria-hidden", "false");
        syncBodyModalLock();
        if (tasksEmptyRow) {
          tasksEmptyRow.hidden = true;
        }
        if (taskTitleInput) {
          taskTitleInput.focus();
        }
      }

      function closeTaskForm() {
        if (!taskRecordOverlay) {
          return;
        }

        taskRecordOverlay.classList.remove("open");
        taskRecordOverlay.setAttribute("aria-hidden", "true");
        syncBodyModalLock();
        resetTaskForm();
        isEditingTask = false;
        editingTaskRow = null;
        if (taskFormTitle) {
          taskFormTitle.textContent = "Create Task Record";
        }
        if (saveTaskBtn) {
          saveTaskBtn.textContent = "Create";
        }
        refreshTaskCount();
      }

      function formatDueDate(value) {
        if (!value) {
          return "-";
        }
        return value;
      }

      function saveTaskRow() {
        if (!tasksTableBody || !taskTitleInput || !taskStatusInput) {
          return;
        }

        var payload = getTaskPayloadFromForm();
        if (!payload.title) {
          taskTitleInput.focus();
          return;
        }

        if (isEditingTask && editingTaskRow) {
          applyRowPayload(editingTaskRow, payload);
        } else {
          var row = document.createElement("tr");
          applyRowPayload(row, payload);
          tasksTableBody.appendChild(row);
        }

        closeTaskForm();
        refreshTaskCount();
      }

      function openPersonnelModal(personnelRow) {
        if (!personnelModal) {
          return;
        }

        if (personnelRow) {
          var payload = personnelPayloadFromRow(personnelRow);
          editingPersonnelRow = personnelRow;
          setPersonnelModalMode(true);

          if (personnelFirstField) {
            personnelFirstField.value = payload.fullName || "";
          }
          if (personnelEmployeeId) {
            personnelEmployeeId.value = payload.employeeId === "-" ? "" : payload.employeeId;
          }
          if (personnelDivision) {
            personnelDivision.value = payload.division || "";
          }
          if (personnelPosition) {
            personnelPosition.value = payload.position === "-" ? "" : payload.position;
          }
          if (personnelEmail) {
            personnelEmail.value = payload.email === "-" ? "" : payload.email;
          }
          if (personnelPhone) {
            personnelPhone.value = payload.phone === "-" ? "" : payload.phone;
          }
          if (personnelIsHead) {
            personnelIsHead.checked = payload.role === "Division Head";
          }
        } else {
          resetPersonnelFormState();
        }

        personnelModal.classList.add("open");
        personnelModal.setAttribute("aria-hidden", "false");
        syncBodyModalLock();

        if (personnelFirstField) {
          window.setTimeout(function () {
            personnelFirstField.focus();
          }, 0);
        }
      }

      function closePersonnelModal() {
        if (!personnelModal) {
          return;
        }

        personnelModal.classList.remove("open");
        personnelModal.setAttribute("aria-hidden", "true");
        resetPersonnelFormState();
        syncBodyModalLock();
      }

      if (openTaskFormBtn) {
        openTaskFormBtn.addEventListener("click", function () {
          if (taskRecordOverlay && taskRecordOverlay.classList.contains("open")) {
            closeTaskForm();
          } else {
            openTaskForm(null);
          }
        });
      }

      if (newTaskFormCard) {
        newTaskFormCard.addEventListener("submit", function (event) {
          event.preventDefault();
          saveTaskRow();
        });
      }

      if (taskRecordOverlay) {
        taskRecordOverlay.addEventListener("click", function (event) {
          if (event.target === taskRecordOverlay) {
            closeTaskForm();
          }
        });
      }

      if (tasksTableBody) {
        tasksTableBody.addEventListener("click", function (event) {
          var actionBtn = event.target.closest("button[data-task-action]");
          if (!actionBtn) {
            return;
          }

          var row = actionBtn.closest("tr[data-task-row='1']");
          if (!row) {
            return;
          }

          var action = actionBtn.getAttribute("data-task-action");
          if (action === "edit") {
            openTaskForm(row);
            return;
          }

          if (action === "delete") {
            if (editingTaskRow === row) {
              closeTaskForm();
            }
            row.remove();
            refreshTaskCount();
          }
        });
      }

      if (saveTaskBtn) {
        saveTaskBtn.addEventListener("click", function (event) {
          event.preventDefault();
          saveTaskRow();
        });
      }

      if (cancelTaskBtn) {
        cancelTaskBtn.addEventListener("click", closeTaskForm);
      }

      if (openPersonnelModalBtn) {
        openPersonnelModalBtn.addEventListener("click", function () {
          openPersonnelModal(null);
        });
      }

      if (closePersonnelModalBtn) {
        closePersonnelModalBtn.addEventListener("click", closePersonnelModal);
      }

      if (cancelPersonnelModalBtn) {
        cancelPersonnelModalBtn.addEventListener("click", closePersonnelModal);
      }

      if (personnelForm) {
        personnelForm.addEventListener("submit", function (event) {
          event.preventDefault();
          if (!personnelTableBody) {
            closePersonnelModal();
            return;
          }

          var fullName = personnelFirstField ? personnelFirstField.value.trim() : "";
          var division = personnelDivision ? personnelDivision.value : "";
          if (!fullName || !division) {
            return;
          }

          var payload = {
            fullName: fullName,
            employeeId: personnelEmployeeId && personnelEmployeeId.value.trim() ? personnelEmployeeId.value.trim() : "-",
            division: division,
            position: personnelPosition && personnelPosition.value.trim() ? personnelPosition.value.trim() : "-",
            email: personnelEmail && personnelEmail.value.trim() ? personnelEmail.value.trim() : "-",
            phone: personnelPhone && personnelPhone.value.trim() ? personnelPhone.value.trim() : "-",
            role: personnelIsHead && personnelIsHead.checked ? "Division Head" : "Personnel"
          };

          if (editingPersonnelRow) {
            applyPersonnelRowPayload(editingPersonnelRow, payload);
          } else {
            personnelTableBody.appendChild(createPersonnelRow(payload));
          }
          refreshPersonnelCount();
          closePersonnelModal();
        });
      }

      if (personnelTableBody) {
        personnelTableBody.addEventListener("click", function (event) {
          var actionBtn = event.target.closest("button[data-personnel-action]");
          if (!actionBtn) {
            return;
          }

          var row = actionBtn.closest("tr[data-personnel-row='1']");
          if (!row) {
            return;
          }

          var action = actionBtn.getAttribute("data-personnel-action");
          if (action === "edit") {
            openPersonnelModal(row);
            return;
          }

          if (action === "delete") {
            if (editingPersonnelRow === row) {
              closePersonnelModal();
            }
            row.remove();
            refreshPersonnelCount();
          }
        });
      }

      if (personnelModal) {
        personnelModal.addEventListener("click", function (event) {
          if (event.target === personnelModal) {
            closePersonnelModal();
          }
        });
      }

      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          closeTaskForm();
          closePersonnelModal();
        }
      });

      hydrateExistingTaskRows();
      refreshTaskCount();
      refreshPersonnelCount();
    });
  </script>
</body>
</html>
