{% load static %}
{% if user.is_authenticated %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'styles.css' %}">
    <title>PEO Portal Dashboard</title>
    </head>
<body>
    <div class="app-shell">
        <aside class="sidebar">
            <div class="brand">
                <div class="brand-logo">PEO</div>
                <div>
                    <h1>PEO Portal</h1>
                    <p>Workflow Management</p>
                </div>
            </div>

            <nav class="nav-menu">
                <a class="nav-item active" href="{% url 'home' %}">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <rect x="3" y="3" width="7" height="7" rx="1.8" stroke="currentColor" stroke-width="2"/>
                        <rect x="14" y="3" width="7" height="7" rx="1.8" stroke="currentColor" stroke-width="2"/>
                        <rect x="3" y="14" width="7" height="7" rx="1.8" stroke="currentColor" stroke-width="2"/>
                        <rect x="14" y="14" width="7" height="7" rx="1.8" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    Dashboard
                    <span class="caret">&#8250;</span>
                </a>
                <a class="nav-item" href="{% url 'admin_div_dashboard' %}"><svg class="nav-icon" viewBox="0 0 24 24" fill="none"><path d="M7 20v-2a4 4 0 0 1 4-4h2a4 4 0 0 1 4 4v2" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2"/><path d="M3 10c0-1.7 1.3-3 3-3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>Admin Division</a>
                <a id="planningDivisionNavLink" class="nav-item" href="{% url 'planning_div_dashboard' %}"><svg class="nav-icon" viewBox="0 0 24 24" fill="none"><rect x="5" y="3" width="14" height="18" rx="2" stroke="currentColor" stroke-width="2"/><path d="M9 7h6M9 11h6M9 15h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>Planning Division</a>
                <a id="constructionDivisionNavLink" class="nav-item" href="{% url 'construction_div_dashboard' %}"><svg class="nav-icon" viewBox="0 0 24 24" fill="none"><path d="M14 5 5 14l-1 5 5-1 9-9-4-4Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/><path d="m13 6 4 4" stroke="currentColor" stroke-width="2"/></svg>Construction Division</a>
                <a id="qualityDivisionNavLink" class="nav-item" href="{% url 'quality_div_dashboard' %}"><svg class="nav-icon" viewBox="0 0 24 24" fill="none"><path d="M12 3 5 6v6c0 5 3.5 7.5 7 9 3.5-1.5 7-4 7-9V6l-7-3Z" stroke="currentColor" stroke-width="2"/><path d="m9 12 2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>Quality Division</a>
                <div class="nav-group open" id="maintenanceNavGroup">
                    <div class="nav-item nav-item-group active">
                        <button class="nav-main-link" id="maintenanceMainLink" type="button" aria-expanded="true" aria-controls="maintenanceSubmenu">
                            <svg class="nav-icon" viewBox="0 0 24 24" fill="none"><path d="m14 6-8 8 4 4 8-8-4-4Z" stroke="currentColor" stroke-width="2"/><path d="M6 14 4 20l6-2" stroke="currentColor" stroke-width="2"/></svg>
                            Maintenance Division
                        </button>
                        <button class="nav-action-btn" id="maintenanceActionBtn" type="button" aria-expanded="true" aria-controls="maintenanceSubmenu" aria-label="Open maintenance actions">
                            <svg viewBox="0 0 24 24" fill="none"><path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </button>
                    </div>
                    <div class="nav-submenu" id="maintenanceSubmenu" aria-hidden="false">
                        <a class="nav-subitem" href="{% url 'maintinance_div_dashboard' %}">Maintinance Management</a>
                        <a class="nav-subitem" href="{% url 'maintinance_task_management' %}">Task Management</a>
                        <a class="nav-subitem" href="{% url 'maintinance_contractor_management' %}">Contractor Management</a>
                    </div>
</div>
                <a id="myAssignmentsNavLink" class="nav-item" href="{% url 'my_assignments' %}"><svg class="nav-icon" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/><path d="m9.5 12 1.7 1.7L15 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>My Assignments</a>
            </nav>
        </aside>

        <div class="workspace">
            <header class="topbar">
                <div class="top-controls">
                    <label class="search">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                            <circle cx="11" cy="11" r="6.8" stroke="#4f647d" stroke-width="2"></circle>
                            <path d="M16 16L21 21" stroke="#4f647d" stroke-width="2" stroke-linecap="round"></path>
                        </svg>
                        <input type="text" placeholder="Search projects, documents, tasks..." />
                    </label>
                    <button class="filter-btn" type="button">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                            <path d="M4 5h16l-6 7v6l-4 2v-8L4 5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                        </svg>
                        Filter
                    </button>
                </div>

                <div class="account">
                    <div class="seal">OFFICE<br>OF PEO</div>
                    <div class="avatar">{{ user.username|slice:":1"|upper }}</div>
                    <form class="logout-form" action="{% url 'logout' %}" method="post">
                        {% csrf_token %}
                        <button class="logout-btn" type="submit">Logout</button>
                    </form>
                </div>
            </header>

            <main class="page">
                <div id="homeDashboardSections" class="dashboard-sections">
                    <section class="hero">
                        <div class="hero-body">
                            <h2>Operations Dashboard</h2>
                            <p>Track division workflows, project stages, documents, and task accountability across the Provincial Engineering Office.</p>
                            <div class="hero-actions">
                                <button class="btn-primary" type="button">
                                    <span>+</span>
                                    <span>New item</span>
                                </button>
                                <button class="btn-secondary" type="button">Export Report</button>
                            </div>
                        </div>
                    </section>

                    <section class="metrics">
                        <article class="metric-card">
                            <div class="metric-icon">
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
                                    <rect x="5" y="3" width="14" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
                                    <path d="M9 7h6M9 11h6M9 15h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </div>
                            <div class="metric-text">
                                <strong>1626</strong>
                                <span>Total Projects</span>
                            </div>
                        </article>
                        <article class="metric-card">
                            <div class="metric-icon">
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
                                    <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
                                    <path d="m9.5 12 1.7 1.7L15 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </div>
                            <div class="metric-text">
                                <strong>1256</strong>
                                <span>Completed</span>
                            </div>
                        </article>
                        <article class="metric-card">
                            <div class="metric-icon">
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
                                    <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
                                    <path d="M12 7v5l3 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </div>
                            <div class="metric-text">
                                <strong>49</strong>
                                <span>Ongoing</span>
                            </div>
                        </article>
                        <article class="metric-card">
                            <div class="metric-icon">
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
                                    <path d="M12 4 3 20h18L12 4Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                                    <path d="M12 10v4M12 18h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </div>
                            <div class="metric-text">
                                <strong>PHP 4.2B</strong>
                                <span>Total Cost</span>
                            </div>
                        </article>
                    </section>

                    <section class="data-tabs" aria-label="Data sections">
                        <button class="data-tab active" type="button">Divisions</button>
                        <button class="data-tab" type="button">Projects</button>
                        <button class="data-tab" type="button">Document Register</button>
                        <button class="data-tab" type="button">Task Matrix</button>
                    </section>
                </div>

                <section id="embeddedMaintenancePanel" class="embedded-maintenance" aria-hidden="true">
                    <iframe id="embeddedMaintenanceFrame" class="embedded-frame" src="about:blank" loading="lazy" title="Maintenance View"></iframe>
                </section>
            </main>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var mainLink = document.getElementById("maintenanceMainLink");
            var actionBtn = document.getElementById("maintenanceActionBtn");
            var submenu = document.getElementById("maintenanceSubmenu");
            var group = document.getElementById("maintenanceNavGroup");
            var page = document.querySelector(".page");
            var dashboardSections = document.getElementById("homeDashboardSections");
            var embeddedPanel = document.getElementById("embeddedMaintenancePanel");
            var embeddedFrame = document.getElementById("embeddedMaintenanceFrame");
            var myAssignmentsNavLink = document.getElementById("myAssignmentsNavLink");
            var qualityDivisionNavLink = document.getElementById("qualityDivisionNavLink");
            var planningDivisionNavLink = document.getElementById("planningDivisionNavLink");
            var constructionDivisionNavLink = document.getElementById("constructionDivisionNavLink");
            var appShell = document.querySelector(".app-shell");
            var sidebar = document.querySelector(".sidebar");
            var sidebarToggleBtn = document.getElementById("sidebarToggleBtn");
            var sidebarStorageKey = "peo_sidebar_collapsed";
            if (!mainLink || !actionBtn || !submenu || !group) {
                return;
            }

            var subItems = submenu.querySelectorAll(".nav-subitem");

            function playBlink(target) {
                if (target) {
                    target.classList.remove("blink");
                    void target.offsetWidth;
                    target.classList.add("blink");
                    window.setTimeout(function () {
                        target.classList.remove("blink");
                    }, 520);
                }

                if (page) {
                    page.classList.remove("panel-blink");
                    void page.offsetWidth;
                    page.classList.add("panel-blink");
                    window.setTimeout(function () {
                        page.classList.remove("panel-blink");
                    }, 440);
                }
            }

            function toggleMaintenanceMenu(event) {
                if (event) {
                    event.preventDefault();
                }

                var isOpen = actionBtn.getAttribute("aria-expanded") === "true";
                actionBtn.setAttribute("aria-expanded", String(!isOpen));
                mainLink.setAttribute("aria-expanded", String(!isOpen));
                submenu.setAttribute("aria-hidden", String(isOpen));
                group.classList.toggle("open", !isOpen);
            }

            function openEmbeddedMaintenance(link, title) {
                if (!embeddedPanel || !embeddedFrame) {
                    window.location.href = link;
                    return;
                }

                if (dashboardSections) {
                    dashboardSections.classList.add("hidden");
                }

                embeddedPanel.classList.add("visible");
                embeddedPanel.setAttribute("aria-hidden", "false");

                if (embeddedFrame.getAttribute("src") !== link) {
                    embeddedFrame.setAttribute("src", link);
                }

                var targetTop = embeddedPanel.getBoundingClientRect().top + window.scrollY - 88;
                window.scrollTo({ top: targetTop, behavior: "smooth" });
            }

            function closeEmbeddedMaintenance() {
                if (!embeddedPanel) {
                    return;
                }

                embeddedPanel.classList.remove("visible");
                embeddedPanel.setAttribute("aria-hidden", "true");

                if (dashboardSections) {
                    dashboardSections.classList.remove("hidden");
                }
            }

            function applySidebarState(isCollapsed) {
                if (!appShell) {
                    return;
                }

                appShell.classList.toggle("sidebar-collapsed", isCollapsed);
                if (sidebarToggleBtn) {
                    sidebarToggleBtn.setAttribute("aria-expanded", String(!isCollapsed));
                    sidebarToggleBtn.setAttribute("aria-label", isCollapsed ? "Show sidebar" : "Hide sidebar");
                }
            }

            if (appShell && sidebar) {
                var isMobileLayout = window.matchMedia("(max-width: 980px)").matches;
                var storedCollapsed = window.localStorage.getItem(sidebarStorageKey) === "1";
                applySidebarState(!isMobileLayout && storedCollapsed);

                var autoHideDelayMs = 5000;
                var autoHideTimer = null;
                var lastMouseX = null;

                function isDesktopAutoMode() {
                    return !window.matchMedia("(max-width: 980px)").matches;
                }

                function clearAutoHideTimer() {
                    if (autoHideTimer) {
                        window.clearTimeout(autoHideTimer);
                        autoHideTimer = null;
                    }
                }

                function expandSidebar() {
                    if (!appShell.classList.contains("sidebar-collapsed")) {
                        return;
                    }
                    applySidebarState(false);
                    window.localStorage.setItem(sidebarStorageKey, "0");
                }

                function collapseSidebar() {
                    if (appShell.classList.contains("sidebar-collapsed")) {
                        return;
                    }
                    applySidebarState(true);
                    window.localStorage.setItem(sidebarStorageKey, "1");
                }

                function restartAutoHideTimer() {
                    clearAutoHideTimer();
                    if (!isDesktopAutoMode()) {
                        return;
                    }
                    if (appShell.classList.contains("sidebar-collapsed")) {
                        return;
                    }
                    autoHideTimer = window.setTimeout(collapseSidebar, autoHideDelayMs);
                }

                function handlePointerActivity(event) {
                    if (!isDesktopAutoMode()) {
                        return;
                    }
                    var currentX = typeof event.clientX === "number" ? event.clientX : lastMouseX;
                    var movingLeft = typeof currentX === "number" && typeof lastMouseX === "number" && currentX < (lastMouseX - 4);
                    var pointerInsideSidebar = sidebar.contains(event.target);
                    var nearLeftEdge = typeof currentX === "number" && currentX <= 80;
                    if (pointerInsideSidebar || nearLeftEdge || movingLeft) {
                        expandSidebar();
                    }
                    restartAutoHideTimer();
                    if (typeof currentX === "number") {
                        lastMouseX = currentX;
                    }
                }

                document.addEventListener("mousemove", handlePointerActivity);
                document.addEventListener("mousedown", handlePointerActivity);
                document.addEventListener("keydown", restartAutoHideTimer);
                document.addEventListener("wheel", restartAutoHideTimer, { passive: true });
                window.addEventListener("focus", restartAutoHideTimer);

                window.addEventListener("resize", function () {
                    clearAutoHideTimer();
                    lastMouseX = null;
                    if (window.matchMedia("(max-width: 980px)").matches) {
                        applySidebarState(false);
                        return;
                    }
                    var collapsedState = window.localStorage.getItem(sidebarStorageKey) === "1";
                    applySidebarState(collapsedState);
                    restartAutoHideTimer();
                });

                restartAutoHideTimer();
            }

            mainLink.addEventListener("click", toggleMaintenanceMenu);
            actionBtn.addEventListener("click", toggleMaintenanceMenu);
            subItems.forEach(function (item) {
                item.addEventListener("click", function (event) {
                    event.preventDefault();
                    playBlink(item);

                    var link = item.getAttribute("href");
                    if (link) {
                        window.setTimeout(function () {
                            openEmbeddedMaintenance(link, item.textContent.trim());
                        }, 180);
                    }
                });
            });

            if (myAssignmentsNavLink) {
                myAssignmentsNavLink.addEventListener("click", function (event) {
                    event.preventDefault();
                    playBlink(myAssignmentsNavLink);

                    var link = myAssignmentsNavLink.getAttribute("href");
                    if (link) {
                        window.setTimeout(function () {
                            openEmbeddedMaintenance(link, "My Assignments");
                        }, 180);
                    }
                });
            }

            if (qualityDivisionNavLink) {
                qualityDivisionNavLink.addEventListener("click", function (event) {
                    event.preventDefault();
                    playBlink(qualityDivisionNavLink);

                    var link = qualityDivisionNavLink.getAttribute("href");
                    if (link) {
                        window.setTimeout(function () {
                            openEmbeddedMaintenance(link, "Quality Division");
                        }, 180);
                    }
                });
            }

            if (planningDivisionNavLink) {
                planningDivisionNavLink.addEventListener("click", function (event) {
                    event.preventDefault();
                    playBlink(planningDivisionNavLink);

                    var link = planningDivisionNavLink.getAttribute("href");
                    if (link) {
                        window.setTimeout(function () {
                            openEmbeddedMaintenance(link, "Planning Division");
                        }, 180);
                    }
                });
            }

            if (constructionDivisionNavLink) {
                constructionDivisionNavLink.addEventListener("click", function (event) {
                    event.preventDefault();
                    playBlink(constructionDivisionNavLink);

                    var link = constructionDivisionNavLink.getAttribute("href");
                    if (link) {
                        window.setTimeout(function () {
                            openEmbeddedMaintenance(link, "Construction Division");
                        }, 180);
                    }
                });
            }
        });
    </script>
</body>
</html>
{% else %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PEO Portal</title>
    
</head>
<body class="view-guest">
    <div class="guest-card">
        <h2>You are not logged in.</h2>
        <p><a href="{% url 'login' %}">Click here to login</a></p>
    </div>
</body>
</html>
{% endif %}
